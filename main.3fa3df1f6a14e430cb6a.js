!function(e){var t={};function r(n){if(t[n])return t[n].exports;var a=t[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,r),a.l=!0,a.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(n,a,function(t){return e[t]}.bind(null,a));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=2)}([function(e,t){e.exports=THREE},function(e,t,r){},function(e,t,r){"use strict";r.r(t);var n=r(0),a=function(e,t){this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.target=new n.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.25,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!1,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={LEFT:n.MOUSE.LEFT,MIDDLE:n.MOUSE.MIDDLE,RIGHT:n.MOUSE.RIGHT},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=function(){return u.phi},this.getAzimuthalAngle=function(){return u.theta},this.saveState=function(){r.target0.copy(r.target),r.position0.copy(r.object.position),r.zoom0=r.object.zoom},this.reset=function(){r.target.copy(r.target0),r.object.position.copy(r.position0),r.object.zoom=r.zoom0,r.object.updateProjectionMatrix(),r.dispatchEvent(a),r.update(),l=s.NONE},this.update=function(){var t=new n.Vector3,i=(new n.Quaternion).setFromUnitVectors(e.up,new n.Vector3(0,1,0)),o=i.clone().inverse(),m=new n.Vector3,v=new n.Quaternion;return function(){var e=r.object.position;return t.copy(e).sub(r.target),t.applyQuaternion(i),u.setFromVector3(t),r.autoRotate&&l===s.NONE&&x(2*Math.PI/60/60*r.autoRotateSpeed),u.theta+=p.theta,u.phi+=p.phi,u.theta=Math.max(r.minAzimuthAngle,Math.min(r.maxAzimuthAngle,u.theta)),u.phi=Math.max(r.minPolarAngle,Math.min(r.maxPolarAngle,u.phi)),u.makeSafe(),u.radius*=h,u.radius=Math.max(r.minDistance,Math.min(r.maxDistance,u.radius)),r.target.add(d),t.setFromSpherical(u),t.applyQuaternion(o),e.copy(r.target).add(t),r.object.lookAt(r.target),!0===r.enableDamping?(p.theta*=1-r.dampingFactor,p.phi*=1-r.dampingFactor,d.multiplyScalar(1-r.dampingFactor)):(p.set(0,0,0),d.set(0,0,0)),h=1,!!(f||m.distanceToSquared(r.object.position)>c||8*(1-v.dot(r.object.quaternion))>c)&&(r.dispatchEvent(a),m.copy(r.object.position),v.copy(r.object.quaternion),f=!1,!0)}}(),this.dispose=function(){r.domElement.removeEventListener("contextmenu",G,!1),r.domElement.removeEventListener("mousedown",C,!1),r.domElement.removeEventListener("wheel",N,!1),r.domElement.removeEventListener("touchstart",U,!1),r.domElement.removeEventListener("touchend",j,!1),r.domElement.removeEventListener("touchmove",B,!1),document.removeEventListener("mousemove",D,!1),document.removeEventListener("mouseup",k,!1),window.removeEventListener("keydown",F,!1)};var r=this,a={type:"change"},i={type:"start"},o={type:"end"},s={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY_PAN:4},l=s.NONE,c=1e-6,u=new n.Spherical,p=new n.Spherical,h=1,d=new n.Vector3,f=!1,m=new n.Vector2,v=new n.Vector2,g=new n.Vector2,y=new n.Vector2,b=new n.Vector2,w=new n.Vector2,T=new n.Vector2,E=new n.Vector2,M=new n.Vector2;function S(){return Math.pow(.95,r.zoomSpeed)}function x(e){p.theta-=e}function A(e){p.phi-=e}var L=function(){var e=new n.Vector3;return function(t,r){e.setFromMatrixColumn(r,0),e.multiplyScalar(-t),d.add(e)}}(),R=function(){var e=new n.Vector3;return function(t,n){!0===r.screenSpacePanning?e.setFromMatrixColumn(n,1):(e.setFromMatrixColumn(n,0),e.crossVectors(r.object.up,e)),e.multiplyScalar(t),d.add(e)}}(),I=function(){var e=new n.Vector3;return function(t,n){var a=r.domElement===document?r.domElement.body:r.domElement;if(r.object.isPerspectiveCamera){var i=r.object.position;e.copy(i).sub(r.target);var o=e.length();o*=Math.tan(r.object.fov/2*Math.PI/180),L(2*t*o/a.clientHeight,r.object.matrix),R(2*n*o/a.clientHeight,r.object.matrix)}else r.object.isOrthographicCamera?(L(t*(r.object.right-r.object.left)/r.object.zoom/a.clientWidth,r.object.matrix),R(n*(r.object.top-r.object.bottom)/r.object.zoom/a.clientHeight,r.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),r.enablePan=!1)}}();function _(e){r.object.isPerspectiveCamera?h/=e:r.object.isOrthographicCamera?(r.object.zoom=Math.max(r.minZoom,Math.min(r.maxZoom,r.object.zoom*e)),r.object.updateProjectionMatrix(),f=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),r.enableZoom=!1)}function P(e){r.object.isPerspectiveCamera?h*=e:r.object.isOrthographicCamera?(r.object.zoom=Math.max(r.minZoom,Math.min(r.maxZoom,r.object.zoom/e)),r.object.updateProjectionMatrix(),f=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),r.enableZoom=!1)}function O(e){y.set(e.clientX,e.clientY)}function C(e){if(!1!==r.enabled){switch(e.preventDefault(),r.domElement.focus?r.domElement.focus():window.focus(),e.button){case r.mouseButtons.LEFT:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===r.enablePan)return;O(e),l=s.PAN}else{if(!1===r.enableRotate)return;!function(e){m.set(e.clientX,e.clientY)}(e),l=s.ROTATE}break;case r.mouseButtons.MIDDLE:if(!1===r.enableZoom)return;!function(e){T.set(e.clientX,e.clientY)}(e),l=s.DOLLY;break;case r.mouseButtons.RIGHT:if(!1===r.enablePan)return;O(e),l=s.PAN}l!==s.NONE&&(document.addEventListener("mousemove",D,!1),document.addEventListener("mouseup",k,!1),r.dispatchEvent(i))}}function D(e){if(!1!==r.enabled)switch(e.preventDefault(),l){case s.ROTATE:if(!1===r.enableRotate)return;!function(e){v.set(e.clientX,e.clientY),g.subVectors(v,m).multiplyScalar(r.rotateSpeed);var t=r.domElement===document?r.domElement.body:r.domElement;x(2*Math.PI*g.x/t.clientHeight),A(2*Math.PI*g.y/t.clientHeight),m.copy(v),r.update()}(e);break;case s.DOLLY:if(!1===r.enableZoom)return;!function(e){E.set(e.clientX,e.clientY),M.subVectors(E,T),M.y>0?_(S()):M.y<0&&P(S()),T.copy(E),r.update()}(e);break;case s.PAN:if(!1===r.enablePan)return;!function(e){b.set(e.clientX,e.clientY),w.subVectors(b,y).multiplyScalar(r.panSpeed),I(w.x,w.y),y.copy(b),r.update()}(e)}}function k(e){!1!==r.enabled&&(document.removeEventListener("mousemove",D,!1),document.removeEventListener("mouseup",k,!1),r.dispatchEvent(o),l=s.NONE)}function N(e){!1===r.enabled||!1===r.enableZoom||l!==s.NONE&&l!==s.ROTATE||(e.preventDefault(),e.stopPropagation(),r.dispatchEvent(i),function(e){e.deltaY<0?P(S()):e.deltaY>0&&_(S()),r.update()}(e),r.dispatchEvent(o))}function F(e){!1!==r.enabled&&!1!==r.enableKeys&&!1!==r.enablePan&&function(e){var t=!1;switch(e.keyCode){case r.keys.UP:I(0,r.keyPanSpeed),t=!0;break;case r.keys.BOTTOM:I(0,-r.keyPanSpeed),t=!0;break;case r.keys.LEFT:I(r.keyPanSpeed,0),t=!0;break;case r.keys.RIGHT:I(-r.keyPanSpeed,0),t=!0}t&&(e.preventDefault(),r.update())}(e)}function U(e){if(!1!==r.enabled){switch(e.preventDefault(),e.touches.length){case 1:if(!1===r.enableRotate)return;!function(e){m.set(e.touches[0].pageX,e.touches[0].pageY)}(e),l=s.TOUCH_ROTATE;break;case 2:if(!1===r.enableZoom&&!1===r.enablePan)return;!function(e){if(r.enableZoom){var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,a=Math.sqrt(t*t+n*n);T.set(0,a)}if(r.enablePan){var i=.5*(e.touches[0].pageX+e.touches[1].pageX),o=.5*(e.touches[0].pageY+e.touches[1].pageY);y.set(i,o)}}(e),l=s.TOUCH_DOLLY_PAN;break;default:l=s.NONE}l!==s.NONE&&r.dispatchEvent(i)}}function B(e){if(!1!==r.enabled)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:if(!1===r.enableRotate)return;if(l!==s.TOUCH_ROTATE)return;!function(e){v.set(e.touches[0].pageX,e.touches[0].pageY),g.subVectors(v,m).multiplyScalar(r.rotateSpeed);var t=r.domElement===document?r.domElement.body:r.domElement;x(2*Math.PI*g.x/t.clientHeight),A(2*Math.PI*g.y/t.clientHeight),m.copy(v),r.update()}(e);break;case 2:if(!1===r.enableZoom&&!1===r.enablePan)return;if(l!==s.TOUCH_DOLLY_PAN)return;!function(e){if(r.enableZoom){var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,a=Math.sqrt(t*t+n*n);E.set(0,a),M.set(0,Math.pow(E.y/T.y,r.zoomSpeed)),_(M.y),T.copy(E)}if(r.enablePan){var i=.5*(e.touches[0].pageX+e.touches[1].pageX),o=.5*(e.touches[0].pageY+e.touches[1].pageY);b.set(i,o),w.subVectors(b,y).multiplyScalar(r.panSpeed),I(w.x,w.y),y.copy(b)}r.update()}(e);break;default:l=s.NONE}}function j(e){!1!==r.enabled&&(r.dispatchEvent(o),l=s.NONE)}function G(e){!1!==r.enabled&&e.preventDefault()}r.domElement.addEventListener("contextmenu",G,!1),r.domElement.addEventListener("mousedown",C,!1),r.domElement.addEventListener("wheel",N,!1),r.domElement.addEventListener("touchstart",U,!1),r.domElement.addEventListener("touchend",j,!1),r.domElement.addEventListener("touchmove",B,!1),window.addEventListener("keydown",F,!1),this.update()};a.prototype=Object.create(n.EventDispatcher.prototype),a.prototype.constructor=a,Object.defineProperties(a.prototype,{center:{get:function(){return console.warn("THREE.OrbitControls: .center has been renamed to .target"),this.target}},noZoom:{get:function(){return console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),!this.enableZoom},set:function(e){console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),this.enableZoom=!e}},noRotate:{get:function(){return console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),!this.enableRotate},set:function(e){console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),this.enableRotate=!e}},noPan:{get:function(){return console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),!this.enablePan},set:function(e){console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),this.enablePan=!e}},noKeys:{get:function(){return console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),!this.enableKeys},set:function(e){console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),this.enableKeys=!e}},staticMoving:{get:function(){return console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),!this.enableDamping},set:function(e){console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),this.enableDamping=!e}},dynamicDampingFactor:{get:function(){return console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor},set:function(e){console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor=e}}});class i{constructor(e,t=60){this._container=e,this._fps=t,this._scene=new n.Scene,this._sceneEntities=[],this._initialViewingVector=new n.Vector3(10,10,10),this._isSceneReady=!1,this._updateCamera=()=>{},this.attemptStart=()=>{this._isSceneReady=!!this._sceneEntities&&this._sceneEntities.map(e=>e.isSceneEntityReady()).every(e=>e),this._isSceneReady?(this._sceneEntities.forEach(e=>{this._scene.add(e.getSceneEntityGroup())}),console.log("STARTING ANIMATION!"),this._clock=new n.Clock,this.render()):console.log("SCENE ENTITIES ARE NOT ALL READY!")},this.onWindowResize=()=>{const e=this._container.offsetWidth,t=this._container.offsetHeight;this._camera.aspect=e/t,this._camera.updateProjectionMatrix(),this._renderer.setSize(e,t)},this.render=()=>{this._fps?setTimeout(()=>{this._requestAnimationFrameId=requestAnimationFrame(this.render),this.update()},1e3/this._fps):(this._requestAnimationFrameId=requestAnimationFrame(this.render),this.update())},this.stopRendering=()=>{this._requestAnimationFrameId&&(cancelAnimationFrame(this._requestAnimationFrameId),this._requestAnimationFrameId=void 0)},this._canvas=document.createElement("canvas"),this._canvas.width=this._container.offsetWidth,this._canvas.height=e.offsetHeight,this._container.appendChild(this._canvas);const r=window.devicePixelRatio?window.devicePixelRatio:1;this._renderer=new n.WebGLRenderer({canvas:this._canvas,antialias:!0,alpha:!0}),this._renderer.setPixelRatio(r),this._renderer.gammaInput=!0,this._renderer.gammaOutput=!0,this._renderer.sortObjects=!1,this._renderer.shadowMap.enabled=!0,this._renderer.shadowMap.type=n.PCFSoftShadowMap;const i=this._canvas.width/this._canvas.height;this._camera=new n.PerspectiveCamera(60,i,.1,135e3),this._camera.position.copy(this._initialViewingVector),this._camera.up=new n.Vector3(0,0,1),this._camera.lookAt(0,0,0),this._orbitControls=new a(this._camera,this._renderer.domElement),this._orbitControls.enableDamping=!0,this._orbitControls.dampingFactor=.25,window.onresize=this.onWindowResize,this.onWindowResize()}update(){const e=this._clock?this._clock.getElapsedTime():0;this._sceneEntities.forEach(t=>t.update(e)),this._updateCamera(e),this._renderer.render(this._scene,this._camera)}}class o{constructor(e){this._parentSceneManager=e,this._sceneEntityGroup=new n.Group,this._isSceneEntityReady=!1,this.isSceneEntityReady=()=>this._isSceneEntityReady,this.getSceneEntityGroup=()=>this._sceneEntityGroup,this.setParentSceneManager=e=>this._parentSceneManager=e}}var s={},l=void 0,c=s;function u(e,t){var r,n=e.split("."),a=c;!(n[0]in a)&&a.execScript&&a.execScript("var "+n[0]);for(;n.length&&(r=n.shift());)n.length||t===l?a=a[r]?a[r]:a[r]={}:a[r]=t}var p="undefined"!==typeof Uint8Array&&"undefined"!==typeof Uint16Array&&"undefined"!==typeof Uint32Array&&"undefined"!==typeof DataView;function h(e){var t,r,n,a,i,o,s,l,c,u,h=e.length,d=0,f=Number.POSITIVE_INFINITY;for(l=0;l<h;++l)e[l]>d&&(d=e[l]),e[l]<f&&(f=e[l]);for(t=1<<d,r=new(p?Uint32Array:Array)(t),n=1,a=0,i=2;n<=d;){for(l=0;l<h;++l)if(e[l]===n){for(o=0,s=a,c=0;c<n;++c)o=o<<1|1&s,s>>=1;for(u=n<<16|l,c=o;c<t;c+=i)r[c]=u;++a}++n,a<<=1,i<<=1}return[r,d,f]}function d(e,t){switch(this.g=[],this.h=32768,this.d=this.f=this.a=this.l=0,this.input=p?new Uint8Array(e):e,this.m=!1,this.i=m,this.r=!1,!t&&(t={})||(t.index&&(this.a=t.index),t.bufferSize&&(this.h=t.bufferSize),t.bufferType&&(this.i=t.bufferType),t.resize&&(this.r=t.resize)),this.i){case f:this.b=32768,this.c=new(p?Uint8Array:Array)(32768+this.h+258);break;case m:this.b=0,this.c=new(p?Uint8Array:Array)(this.h),this.e=this.z,this.n=this.v,this.j=this.w;break;default:throw Error("invalid inflate mode")}}var f=0,m=1,v={t:f,s:m};d.prototype.k=function(){for(;!this.m;){var e=k(this,3);switch(1&e&&(this.m=!0),e>>>=1){case 0:var t=this.input,r=this.a,n=this.c,a=this.b,i=t.length,o=l,s=n.length,c=l;if(this.d=this.f=0,r+1>=i)throw Error("invalid uncompressed block header: LEN");if(o=t[r++]|t[r++]<<8,r+1>=i)throw Error("invalid uncompressed block header: NLEN");if(o===~(t[r++]|t[r++]<<8))throw Error("invalid uncompressed block header: length verify");if(r+o>t.length)throw Error("input buffer is broken");switch(this.i){case f:for(;a+o>n.length;){if(o-=c=s-a,p)n.set(t.subarray(r,r+c),a),a+=c,r+=c;else for(;c--;)n[a++]=t[r++];this.b=a,n=this.e(),a=this.b}break;case m:for(;a+o>n.length;)n=this.e({p:2});break;default:throw Error("invalid inflate mode")}if(p)n.set(t.subarray(r,r+o),a),a+=o,r+=o;else for(;o--;)n[a++]=t[r++];this.a=r,this.b=a,this.c=n;break;case 1:this.j(O,D);break;case 2:var u,d,v,g,y=k(this,5)+257,b=k(this,5)+1,T=k(this,4)+4,E=new(p?Uint8Array:Array)(w.length),M=l,S=l,x=l,A=l,L=l;for(L=0;L<T;++L)E[w[L]]=k(this,3);if(!p)for(L=T,T=E.length;L<T;++L)E[w[L]]=0;for(u=h(E),M=new(p?Uint8Array:Array)(y+b),L=0,g=y+b;L<g;)switch(S=N(this,u),S){case 16:for(A=3+k(this,2);A--;)M[L++]=x;break;case 17:for(A=3+k(this,3);A--;)M[L++]=0;x=0;break;case 18:for(A=11+k(this,7);A--;)M[L++]=0;x=0;break;default:x=M[L++]=S}d=h(p?M.subarray(0,y):M.slice(0,y)),v=h(p?M.subarray(y):M.slice(y)),this.j(d,v);break;default:throw Error("unknown BTYPE: "+e)}}return this.n()};var g,y,b=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],w=p?new Uint16Array(b):b,T=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],E=p?new Uint16Array(T):T,M=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],S=p?new Uint8Array(M):M,x=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],A=p?new Uint16Array(x):x,L=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],R=p?new Uint8Array(L):L,I=new(p?Uint8Array:Array)(288);for(g=0,y=I.length;g<y;++g)I[g]=143>=g?8:255>=g?9:279>=g?7:8;var _,P,O=h(I),C=new(p?Uint8Array:Array)(30);for(_=0,P=C.length;_<P;++_)C[_]=5;var D=h(C);function k(e,t){for(var r,n=e.f,a=e.d,i=e.input,o=e.a,s=i.length;a<t;){if(o>=s)throw Error("input buffer is broken");n|=i[o++]<<a,a+=8}return r=n&(1<<t)-1,e.f=n>>>t,e.d=a-t,e.a=o,r}function N(e,t){for(var r,n,a=e.f,i=e.d,o=e.input,s=e.a,l=o.length,c=t[0],u=t[1];i<u&&!(s>=l);)a|=o[s++]<<i,i+=8;if((n=(r=c[a&(1<<u)-1])>>>16)>i)throw Error("invalid code length: "+n);return e.f=a>>n,e.d=i-n,e.a=s,65535&r}function F(e,t){var r,n;switch(this.input=e,this.a=0,!t&&(t={})||(t.index&&(this.a=t.index),t.verify&&(this.A=t.verify)),r=e[this.a++],n=e[this.a++],15&r){case U:this.method=U;break;default:throw Error("unsupported compression method")}if(0!==((r<<8)+n)%31)throw Error("invalid fcheck flag:"+((r<<8)+n)%31);if(32&n)throw Error("fdict flag is not supported");this.q=new d(e,{index:this.a,bufferSize:t.bufferSize,bufferType:t.bufferType,resize:t.resize})}d.prototype.j=function(e,t){var r=this.c,n=this.b;this.o=e;for(var a,i,o,s,l=r.length-258;256!==(a=N(this,e));)if(256>a)n>=l&&(this.b=n,r=this.e(),n=this.b),r[n++]=a;else for(s=E[i=a-257],0<S[i]&&(s+=k(this,S[i])),a=N(this,t),o=A[a],0<R[a]&&(o+=k(this,R[a])),n>=l&&(this.b=n,r=this.e(),n=this.b);s--;)r[n]=r[n++-o];for(;8<=this.d;)this.d-=8,this.a--;this.b=n},d.prototype.w=function(e,t){var r=this.c,n=this.b;this.o=e;for(var a,i,o,s,l=r.length;256!==(a=N(this,e));)if(256>a)n>=l&&(l=(r=this.e()).length),r[n++]=a;else for(s=E[i=a-257],0<S[i]&&(s+=k(this,S[i])),a=N(this,t),o=A[a],0<R[a]&&(o+=k(this,R[a])),n+s>l&&(l=(r=this.e()).length);s--;)r[n]=r[n++-o];for(;8<=this.d;)this.d-=8,this.a--;this.b=n},d.prototype.e=function(){var e,t,r=new(p?Uint8Array:Array)(this.b-32768),n=this.b-32768,a=this.c;if(p)r.set(a.subarray(32768,r.length));else for(e=0,t=r.length;e<t;++e)r[e]=a[e+32768];if(this.g.push(r),this.l+=r.length,p)a.set(a.subarray(n,n+32768));else for(e=0;32768>e;++e)a[e]=a[n+e];return this.b=32768,a},d.prototype.z=function(e){var t,r,n,a=this.input.length/this.a+1|0,i=this.input,o=this.c;return e&&("number"===typeof e.p&&(a=e.p),"number"===typeof e.u&&(a+=e.u)),2>a?r=(n=(i.length-this.a)/this.o[2]/2*258|0)<o.length?o.length+n:o.length<<1:r=o.length*a,p?(t=new Uint8Array(r)).set(o):t=o,this.c=t},d.prototype.n=function(){var e,t,r,n,a,i=0,o=this.c,s=this.g,l=new(p?Uint8Array:Array)(this.l+(this.b-32768));if(0===s.length)return p?this.c.subarray(32768,this.b):this.c.slice(32768,this.b);for(t=0,r=s.length;t<r;++t)for(n=0,a=(e=s[t]).length;n<a;++n)l[i++]=e[n];for(t=32768,r=this.b;t<r;++t)l[i++]=o[t];return this.g=[],this.buffer=l},d.prototype.v=function(){var e,t=this.b;return p?this.r?(e=new Uint8Array(t)).set(this.c.subarray(0,t)):e=this.c.subarray(0,t):(this.c.length>t&&(this.c.length=t),e=this.c),this.buffer=e},F.prototype.k=function(){var e,t,r=this.input;if(e=this.q.k(),this.a=this.q.a,this.A){t=(r[this.a++]<<24|r[this.a++]<<16|r[this.a++]<<8|r[this.a++])>>>0;var n=e;if("string"===typeof n){var a,i,o=n.split("");for(a=0,i=o.length;a<i;a++)o[a]=(255&o[a].charCodeAt(0))>>>0;n=o}for(var s,l=1,c=0,u=n.length,p=0;0<u;){u-=s=1024<u?1024:u;do{c+=l+=n[p++]}while(--s);l%=65521,c%=65521}if(t!==(c<<16|l)>>>0)throw Error("invalid adler-32 checksum")}return e};var U=8;u("Zlib.Inflate",F),u("Zlib.Inflate.prototype.decompress",F.prototype.k);var B,j,G,H,V={ADAPTIVE:v.s,BLOCK:v.t};if(Object.keys)B=Object.keys(V);else for(j in B=[],G=0,V)B[G++]=j;for(G=0,H=B.length;G<H;++G)u("Zlib.Inflate.BufferType."+(j=B[G]),V[j]);var z=s.Zlib,X=function(e){this.manager=void 0!==e?e:n.DefaultLoadingManager};X.prototype={constructor:X,load:function(e,t,r,a){var i=this,o=new n.Texture,s=new n.FileLoader(this.manager);return s.setResponseType("arraybuffer"),s.setPath(this.path),s.load(e,function(e){o.image=i.parse(e),o.needsUpdate=!0,void 0!==t&&t(o)},r,a),o},parse:function(e){var t=0,r=1,n=2,a=3,i=9,o=10,s=11,l=48,c=4,u=0,p=1,h=2,d=3;e.length<19&&console.error("THREE.TGALoader: Not enough data to contain header.");var f=new Uint8Array(e),m=0,v={id_length:f[m++],colormap_type:f[m++],image_type:f[m++],colormap_index:f[m++]|f[m++]<<8,colormap_length:f[m++]|f[m++]<<8,colormap_size:f[m++],origin:[f[m++]|f[m++]<<8,f[m++]|f[m++]<<8],width:f[m++]|f[m++]<<8,height:f[m++]|f[m++]<<8,pixel_size:f[m++],flags:f[m++]};!function(e){switch(e.image_type){case r:case i:(e.colormap_length>256||24!==e.colormap_size||1!==e.colormap_type)&&console.error("THREE.TGALoader: Invalid type colormap data for indexed type.");break;case n:case a:case o:case s:e.colormap_type&&console.error("THREE.TGALoader: Invalid type colormap data for colormap type.");break;case t:console.error("THREE.TGALoader: No data.");default:console.error('THREE.TGALoader: Invalid type "%s".',e.image_type)}(e.width<=0||e.height<=0)&&console.error("THREE.TGALoader: Invalid image size."),8!==e.pixel_size&&16!==e.pixel_size&&24!==e.pixel_size&&32!==e.pixel_size&&console.error('THREE.TGALoader: Invalid pixel size "%s".',e.pixel_size)}(v),v.id_length+m>e.length&&console.error("THREE.TGALoader: No data."),m+=v.id_length;var g=!1,y=!1,b=!1;switch(v.image_type){case i:g=!0,y=!0;break;case r:y=!0;break;case o:g=!0;break;case n:break;case s:g=!0,b=!0;break;case a:b=!0}var w="undefined"!==typeof OffscreenCanvas,T=w?new OffscreenCanvas(v.width,v.height):document.createElement("canvas");T.width=v.width,T.height=v.height;var E=T.getContext("2d"),M=E.createImageData(v.width,v.height),S=function(e,t,r,n,a){var i,o,s,l;if(o=r.pixel_size>>3,s=r.width*r.height*o,t&&(l=a.subarray(n,n+=r.colormap_length*(r.colormap_size>>3))),e){var c,u,p;i=new Uint8Array(s);for(var h=0,d=new Uint8Array(o);h<s;)if(u=1+(127&(c=a[n++])),128&c){for(p=0;p<o;++p)d[p]=a[n++];for(p=0;p<u;++p)i.set(d,h+p*o);h+=o*u}else{for(u*=o,p=0;p<u;++p)i[h+p]=a[n++];h+=u}}else i=a.subarray(n,n+=t?r.width*r.height:s);return{pixel_data:i,palettes:l}}(g,y,v,m,f);!function(e,t,r,n,a){var i,o,s,f,m,g;switch((v.flags&l)>>c){default:case h:i=0,s=1,m=t,o=0,f=1,g=r;break;case u:i=0,s=1,m=t,o=r-1,f=-1,g=-1;break;case d:i=t-1,s=-1,m=-1,o=0,f=1,g=r;break;case p:i=t-1,s=-1,m=-1,o=r-1,f=-1,g=-1}if(b)switch(v.pixel_size){case 8:!function(e,t,r,n,a,i,o,s){var l,c,u,p=0,h=v.width;for(u=t;u!==n;u+=r)for(c=a;c!==o;c+=i,p++)l=s[p],e[4*(c+h*u)+0]=l,e[4*(c+h*u)+1]=l,e[4*(c+h*u)+2]=l,e[4*(c+h*u)+3]=255}(e,o,f,g,i,s,m,n);break;case 16:!function(e,t,r,n,a,i,o,s){var l,c,u=0,p=v.width;for(c=t;c!==n;c+=r)for(l=a;l!==o;l+=i,u+=2)e[4*(l+p*c)+0]=s[u+0],e[4*(l+p*c)+1]=s[u+0],e[4*(l+p*c)+2]=s[u+0],e[4*(l+p*c)+3]=s[u+1]}(e,o,f,g,i,s,m,n);break;default:console.error("THREE.TGALoader: Format not supported.")}else switch(v.pixel_size){case 8:!function(e,t,r,n,a,i,o,s,l){var c,u,p,h=l,d=0,f=v.width;for(p=t;p!==n;p+=r)for(u=a;u!==o;u+=i,d++)c=s[d],e[4*(u+f*p)+3]=255,e[4*(u+f*p)+2]=h[3*c+0],e[4*(u+f*p)+1]=h[3*c+1],e[4*(u+f*p)+0]=h[3*c+2]}(e,o,f,g,i,s,m,n,a);break;case 16:!function(e,t,r,n,a,i,o,s){var l,c,u,p=0,h=v.width;for(u=t;u!==n;u+=r)for(c=a;c!==o;c+=i,p+=2)l=s[p+0]+(s[p+1]<<8),e[4*(c+h*u)+0]=(31744&l)>>7,e[4*(c+h*u)+1]=(992&l)>>2,e[4*(c+h*u)+2]=(31&l)>>3,e[4*(c+h*u)+3]=32768&l?0:255}(e,o,f,g,i,s,m,n);break;case 24:!function(e,t,r,n,a,i,o,s){var l,c,u=0,p=v.width;for(c=t;c!==n;c+=r)for(l=a;l!==o;l+=i,u+=3)e[4*(l+p*c)+3]=255,e[4*(l+p*c)+2]=s[u+0],e[4*(l+p*c)+1]=s[u+1],e[4*(l+p*c)+0]=s[u+2]}(e,o,f,g,i,s,m,n);break;case 32:!function(e,t,r,n,a,i,o,s){var l,c,u=0,p=v.width;for(c=t;c!==n;c+=r)for(l=a;l!==o;l+=i,u+=4)e[4*(l+p*c)+2]=s[u+0],e[4*(l+p*c)+1]=s[u+1],e[4*(l+p*c)+0]=s[u+2],e[4*(l+p*c)+3]=s[u+3]}(e,o,f,g,i,s,m,n);break;default:console.error("THREE.TGALoader: Format not supported.")}}(M.data,v.width,v.height,S.pixel_data,S.palettes);return E.putImageData(M,0,0),w?T.transferToImageBitmap():T},setPath:function(e){return this.path=e,this}};var K={findSpan:function(e,t,r){var n=r.length-e-1;if(t>=r[n])return n-1;if(t<=r[e])return e;for(var a=e,i=n,o=Math.floor((a+i)/2);t<r[o]||t>=r[o+1];)t<r[o]?i=o:a=o,o=Math.floor((a+i)/2);return o},calcBasisFunctions:function(e,t,r,n){var a=[],i=[],o=[];a[0]=1;for(var s=1;s<=r;++s){i[s]=t-n[e+1-s],o[s]=n[e+s]-t;for(var l=0,c=0;c<s;++c){var u=o[c+1],p=i[s-c],h=a[c]/(u+p);a[c]=l+u*h,l=p*h}a[s]=l}return a},calcBSplinePoint:function(e,t,r,a){for(var i=this.findSpan(e,a,t),o=this.calcBasisFunctions(i,a,e,t),s=new n.Vector4(0,0,0,0),l=0;l<=e;++l){var c=r[i-e+l],u=o[l],p=c.w*u;s.x+=c.x*p,s.y+=c.y*p,s.z+=c.z*p,s.w+=c.w*u}return s},calcBasisFunctionDerivatives:function(e,t,r,n,a){for(var i=[],o=0;o<=r;++o)i[o]=0;var s=[];for(o=0;o<=n;++o)s[o]=i.slice(0);var l=[];for(o=0;o<=r;++o)l[o]=i.slice(0);l[0][0]=1;for(var c=i.slice(0),u=i.slice(0),p=1;p<=r;++p){c[p]=t-a[e+1-p],u[p]=a[e+p]-t;for(var h=0,d=0;d<p;++d){var f=u[d+1],m=c[p-d];l[p][d]=f+m;var v=l[d][p-1]/l[p][d];l[d][p]=h+f*v,h=m*v}l[p][p]=h}for(p=0;p<=r;++p)s[0][p]=l[p][r];for(d=0;d<=r;++d){var g=0,y=1,b=[];for(o=0;o<=r;++o)b[o]=i.slice(0);b[0][0]=1;for(var w=1;w<=n;++w){var T=0,E=d-w,M=r-w;d>=w&&(b[y][0]=b[g][0]/l[M+1][E],T=b[y][0]*l[E][M]);var S=d-1<=M?w-1:r-d;for(p=E>=-1?1:-E;p<=S;++p)b[y][p]=(b[g][p]-b[g][p-1])/l[M+1][E+p],T+=b[y][p]*l[E+p][M];d<=M&&(b[y][w]=-b[g][w-1]/l[M+1][d],T+=b[y][w]*l[d][M]),s[w][d]=T;p=g;g=y,y=p}}for(d=r,w=1;w<=n;++w){for(p=0;p<=r;++p)s[w][p]*=d;d*=r-w}return s},calcBSplineDerivatives:function(e,t,r,a,i){for(var o=i<e?i:e,s=[],l=this.findSpan(e,a,t),c=this.calcBasisFunctionDerivatives(l,a,e,o,t),u=[],p=0;p<r.length;++p){var h=(f=r[p].clone()).w;f.x*=h,f.y*=h,f.z*=h,u[p]=f}for(var d=0;d<=o;++d){for(var f=u[l-e].clone().multiplyScalar(c[d][0]),m=1;m<=e;++m)f.add(u[l-e+m].clone().multiplyScalar(c[d][m]));s[d]=f}for(d=o+1;d<=i+1;++d)s[d]=new n.Vector4(0,0,0);return s},calcKoverI:function(e,t){for(var r=1,n=2;n<=e;++n)r*=n;var a=1;for(n=2;n<=t;++n)a*=n;for(n=2;n<=e-t;++n)a*=n;return r/a},calcRationalCurveDerivatives:function(e){for(var t=e.length,r=[],a=[],i=0;i<t;++i){var o=e[i];r[i]=new n.Vector3(o.x,o.y,o.z),a[i]=o.w}for(var s=[],l=0;l<t;++l){var c=r[l].clone();for(i=1;i<=l;++i)c.sub(s[l-i].clone().multiplyScalar(this.calcKoverI(l,i)*a[i]));s[l]=c.divideScalar(a[0])}return s},calcNURBSDerivatives:function(e,t,r,n,a){var i=this.calcBSplineDerivatives(e,t,r,n,a);return this.calcRationalCurveDerivatives(i)},calcSurfacePoint:function(e,t,r,a,i,o,s,l){for(var c=this.findSpan(e,o,r),u=this.findSpan(t,s,a),p=this.calcBasisFunctions(c,o,e,r),h=this.calcBasisFunctions(u,s,t,a),d=[],f=0;f<=t;++f){d[f]=new n.Vector4(0,0,0,0);for(var m=0;m<=e;++m){var v=i[c-e+m][u-t+f].clone(),g=v.w;v.x*=g,v.y*=g,v.z*=g,d[f].add(v.multiplyScalar(p[m]))}}var y=new n.Vector4(0,0,0,0);for(f=0;f<=t;++f)y.add(d[f].multiplyScalar(h[f]));y.divideScalar(y.w),l.set(y.x,y.y,y.z)}},W=function(e,t,r,a,i){n.Curve.call(this),this.degree=e,this.knots=t,this.controlPoints=[],this.startKnot=a||0,this.endKnot=i||this.knots.length-1;for(var o=0;o<r.length;++o){var s=r[o];this.controlPoints[o]=new n.Vector4(s.x,s.y,s.z,s.w)}};(W.prototype=Object.create(n.Curve.prototype)).constructor=W,W.prototype.getPoint=function(e){var t=this.knots[this.startKnot]+e*(this.knots[this.endKnot]-this.knots[this.startKnot]),r=K.calcBSplinePoint(this.degree,this.knots,this.controlPoints,t);return 1!=r.w&&r.divideScalar(r.w),new n.Vector3(r.x,r.y,r.z)},W.prototype.getTangent=function(e){var t=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),r=K.calcNURBSDerivatives(this.degree,this.knots,this.controlPoints,t,1)[1].clone();return r.normalize(),r};var Y=function(){var e,t,r;function a(e){this.manager=void 0!==e?e:n.DefaultLoadingManager}function i(e){this.textureLoader=e}function o(){}function s(){}function l(){}function c(){}function u(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=void 0===t||t}function p(){}function h(e){var t=e.match(/FBXVersion: (\d+)/);if(t)return parseInt(t[1]);throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function d(e){return e/46186158e3}a.prototype={constructor:a,crossOrigin:"anonymous",load:function(e,t,r,a){var i=this,o=void 0===i.path?n.LoaderUtils.extractUrlBase(e):i.path,s=new n.FileLoader(this.manager);s.setPath(i.path),s.setResponseType("arraybuffer"),s.load(e,function(r){try{t(i.parse(r,o))}catch(n){setTimeout(function(){a&&a(n),i.manager.itemError(e)},0)}},r,a)},setPath:function(e){return this.path=e,this},setResourcePath:function(e){return this.resourcePath=e,this},setCrossOrigin:function(e){return this.crossOrigin=e,this},parse:function(t,r){if(function(e){var t="Kaydara FBX Binary  \0";return e.byteLength>=t.length&&t===T(e,0,t.length)}(t))e=(new c).parse(t);else{var a=T(t);if(!function(e){var t=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"],r=0;function n(t){var n=e[t-1];return e=e.slice(r+t),r++,n}for(var a=0;a<t.length;++a){var i=n(1);if(i===t[a])return!1}return!0}(a))throw new Error("THREE.FBXLoader: Unknown format.");if(h(a)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+h(a));e=(new l).parse(a)}return new i(new n.TextureLoader(this.manager).setPath(this.resourcePath||r).setCrossOrigin(this.crossOrigin)).parse(e)}},i.prototype={constructor:i,parse:function(){t=this.parseConnections();var e=this.parseImages(),n=this.parseTextures(e),a=this.parseMaterials(n),i=this.parseDeformers(),s=(new o).parse(i);return this.parseScene(i,s,a),r},parseConnections:function(){var t=new Map;"Connections"in e&&e.Connections.connections.forEach(function(e){var r=e[0],n=e[1],a=e[2];t.has(r)||t.set(r,{parents:[],children:[]});var i={ID:n,relationship:a};t.get(r).parents.push(i),t.has(n)||t.set(n,{parents:[],children:[]});var o={ID:r,relationship:a};t.get(n).children.push(o)});return t},parseImages:function(){var t={},r={};if("Video"in e.Objects){var n=e.Objects.Video;for(var a in n){var i=n[a];if(t[c=parseInt(a)]=i.RelativeFilename||i.Filename,"Content"in i){var o=i.Content instanceof ArrayBuffer&&i.Content.byteLength>0,s="string"===typeof i.Content&&""!==i.Content;if(o||s){var l=this.parseImage(n[a]);r[i.RelativeFilename||i.Filename]=l}}}}for(var c in t){var u=t[c];void 0!==r[u]?t[c]=r[u]:t[c]=t[c].split("\\").pop()}return t},parseImage:function(e){var t,r=e.Content,a=e.RelativeFilename||e.Filename,i=a.slice(a.lastIndexOf(".")+1).toLowerCase();switch(i){case"bmp":t="image/bmp";break;case"jpg":case"jpeg":t="image/jpeg";break;case"png":t="image/png";break;case"tif":t="image/tiff";break;case"tga":if(null===n.Loader.Handlers.get(".tga")){var o=new X;o.setPath(this.textureLoader.path),n.Loader.Handlers.add(/\.tga$/i,o)}t="image/tga";break;default:return void console.warn('FBXLoader: Image type "'+i+'" is not supported.')}if("string"===typeof r)return"data:"+t+";base64,"+r;var s=new Uint8Array(r);return window.URL.createObjectURL(new Blob([s],{type:t}))},parseTextures:function(t){var r=new Map;if("Texture"in e.Objects){var n=e.Objects.Texture;for(var a in n){var i=this.parseTexture(n[a],t);r.set(parseInt(a),i)}}return r},parseTexture:function(e,t){var r=this.loadTexture(e,t);r.ID=e.id,r.name=e.attrName;var a=e.WrapModeU,i=e.WrapModeV,o=void 0!==a?a.value:0,s=void 0!==i?i.value:0;if(r.wrapS=0===o?n.RepeatWrapping:n.ClampToEdgeWrapping,r.wrapT=0===s?n.RepeatWrapping:n.ClampToEdgeWrapping,"Scaling"in e){var l=e.Scaling.value;r.repeat.x=l[0],r.repeat.y=l[1]}return r},loadTexture:function(e,r){var a,i,o=this.textureLoader.path,s=t.get(e.id).children;void 0!==s&&s.length>0&&void 0!==r[s[0].ID]&&(0!==(a=r[s[0].ID]).indexOf("blob:")&&0!==a.indexOf("data:")||this.textureLoader.setPath(void 0));var l=e.FileName.slice(-3).toLowerCase();if("tga"===l){var c=n.Loader.Handlers.get(".tga");null===c?(console.warn("FBXLoader: TGALoader not found, creating empty placeholder texture for",a),i=new n.Texture):i=c.load(a)}else"psd"===l?(console.warn("FBXLoader: PSD textures are not supported, creating empty placeholder texture for",a),i=new n.Texture):i=this.textureLoader.load(a);return this.textureLoader.setPath(o),i},parseMaterials:function(t){var r=new Map;if("Material"in e.Objects){var n=e.Objects.Material;for(var a in n){var i=this.parseMaterial(n[a],t);null!==i&&r.set(parseInt(a),i)}}return r},parseMaterial:function(e,r){var a=e.id,i=e.attrName,o=e.ShadingModel;if("object"===typeof o&&(o=o.value),!t.has(a))return null;var s,l=this.parseParameters(e,r,a);switch(o.toLowerCase()){case"phong":s=new n.MeshPhongMaterial;break;case"lambert":s=new n.MeshLambertMaterial;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',o),s=new n.MeshPhongMaterial}return s.setValues(l),s.name=i,s},parseParameters:function(e,r,a){var i={};e.BumpFactor&&(i.bumpScale=e.BumpFactor.value),e.Diffuse?i.color=(new n.Color).fromArray(e.Diffuse.value):e.DiffuseColor&&"Color"===e.DiffuseColor.type&&(i.color=(new n.Color).fromArray(e.DiffuseColor.value)),e.DisplacementFactor&&(i.displacementScale=e.DisplacementFactor.value),e.Emissive?i.emissive=(new n.Color).fromArray(e.Emissive.value):e.EmissiveColor&&"Color"===e.EmissiveColor.type&&(i.emissive=(new n.Color).fromArray(e.EmissiveColor.value)),e.EmissiveFactor&&(i.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),e.Opacity&&(i.opacity=parseFloat(e.Opacity.value)),i.opacity<1&&(i.transparent=!0),e.ReflectionFactor&&(i.reflectivity=e.ReflectionFactor.value),e.Shininess&&(i.shininess=e.Shininess.value),e.Specular?i.specular=(new n.Color).fromArray(e.Specular.value):e.SpecularColor&&"Color"===e.SpecularColor.type&&(i.specular=(new n.Color).fromArray(e.SpecularColor.value));var o=this;return t.get(a).children.forEach(function(e){var t=e.relationship;switch(t){case"Bump":i.bumpMap=o.getTexture(r,e.ID);break;case"Maya|TEX_ao_map":i.aoMap=o.getTexture(r,e.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":i.map=o.getTexture(r,e.ID);break;case"DisplacementColor":i.displacementMap=o.getTexture(r,e.ID);break;case"EmissiveColor":i.emissiveMap=o.getTexture(r,e.ID);break;case"NormalMap":case"Maya|TEX_normal_map":i.normalMap=o.getTexture(r,e.ID);break;case"ReflectionColor":i.envMap=o.getTexture(r,e.ID),i.envMap.mapping=n.EquirectangularReflectionMapping;break;case"SpecularColor":i.specularMap=o.getTexture(r,e.ID);break;case"TransparentColor":i.alphaMap=o.getTexture(r,e.ID),i.transparent=!0;break;case"AmbientColor":case"ShininessExponent":case"SpecularFactor":case"VectorDisplacementColor":default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",t)}}),i},getTexture:function(r,n){return"LayeredTexture"in e.Objects&&n in e.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),n=t.get(n).children[0].ID),r.get(n)},parseDeformers:function(){var r={},n={};if("Deformer"in e.Objects){var a=e.Objects.Deformer;for(var i in a){var o=a[i],s=t.get(parseInt(i));if("Skin"===o.attrType){var l=this.parseSkeleton(s,a);l.ID=i,s.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),l.geometryID=s.parents[0].ID,r[i]=l}else if("BlendShape"===o.attrType){var c={id:i};c.rawTargets=this.parseMorphTargets(s,a),c.id=i,s.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),n[i]=c}}}return{skeletons:r,morphTargets:n}},parseSkeleton:function(e,t){var r=[];return e.children.forEach(function(e){var a=t[e.ID];if("Cluster"===a.attrType){var i={ID:e.ID,indices:[],weights:[],transformLink:(new n.Matrix4).fromArray(a.TransformLink.a)};"Indexes"in a&&(i.indices=a.Indexes.a,i.weights=a.Weights.a),r.push(i)}}),{rawBones:r,bones:[]}},parseMorphTargets:function(e,r){for(var n=[],a=0;a<e.children.length;a++){var i=e.children[a],o=r[i.ID],s={name:o.attrName,initialWeight:o.DeformPercent,id:o.id,fullWeights:o.FullWeights.a};if("BlendShapeChannel"!==o.attrType)return;s.geoID=t.get(parseInt(i.ID)).children.filter(function(e){return void 0===e.relationship})[0].ID,n.push(s)}return n},parseScene:function(a,i,o){r=new n.Group;var l=this.parseModels(a.skeletons,i,o),c=e.Objects.Model,u=this;l.forEach(function(e){var n=c[e.ID];u.setLookAtProperties(e,n),t.get(e.ID).parents.forEach(function(t){var r=l.get(t.ID);void 0!==r&&r.add(e)}),null===e.parent&&r.add(e)}),this.bindSkeleton(a.skeletons,i,l),this.createAmbientLight(),this.setupMorphMaterials(),r.traverse(function(e){if(e.userData.transformData){e.parent&&(e.userData.transformData.parentMatrixWorld=e.parent.matrix);var t=y(e.userData.transformData);e.applyMatrix(t)}});var p=(new s).parse();1===r.children.length&&r.children[0].isGroup&&(r.children[0].animations=p,r=r.children[0]),r.animations=p},parseModels:function(r,a,i){var o=new Map,s=e.Objects.Model;for(var l in s){var c=parseInt(l),u=s[l],p=t.get(c),h=this.buildSkeleton(p,r,c,u.attrName);if(!h){switch(u.attrType){case"Camera":h=this.createCamera(p);break;case"Light":h=this.createLight(p);break;case"Mesh":h=this.createMesh(p,a,i);break;case"NurbsCurve":h=this.createCurve(p,a);break;case"LimbNode":case"Root":h=new n.Bone;break;case"Null":default:h=new n.Group}h.name=n.PropertyBinding.sanitizeNodeName(u.attrName),h.ID=c}this.getTransformData(h,u),o.set(c,h)}return o},buildSkeleton:function(e,t,r,a){var i=null;return e.parents.forEach(function(e){for(var o in t){var s=t[o];s.rawBones.forEach(function(t,o){if(t.ID===e.ID){var l=i;(i=new n.Bone).matrixWorld.copy(t.transformLink),i.name=n.PropertyBinding.sanitizeNodeName(a),i.ID=r,s.bones[o]=i,null!==l&&i.add(l)}})}}),i},createCamera:function(t){var r,a;if(t.children.forEach(function(t){var r=e.Objects.NodeAttribute[t.ID];void 0!==r&&(a=r)}),void 0===a)r=new n.Object3D;else{var i=0;void 0!==a.CameraProjectionType&&1===a.CameraProjectionType.value&&(i=1);var o=1;void 0!==a.NearPlane&&(o=a.NearPlane.value/1e3);var s=1e3;void 0!==a.FarPlane&&(s=a.FarPlane.value/1e3);var l=window.innerWidth,c=window.innerHeight;void 0!==a.AspectWidth&&void 0!==a.AspectHeight&&(l=a.AspectWidth.value,c=a.AspectHeight.value);var u=l/c,p=45;void 0!==a.FieldOfView&&(p=a.FieldOfView.value);var h=a.FocalLength?a.FocalLength.value:null;switch(i){case 0:r=new n.PerspectiveCamera(p,u,o,s),null!==h&&r.setFocalLength(h);break;case 1:r=new n.OrthographicCamera(-l/2,l/2,c/2,-c/2,o,s);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+i+"."),r=new n.Object3D}}return r},createLight:function(t){var r,a;if(t.children.forEach(function(t){var r=e.Objects.NodeAttribute[t.ID];void 0!==r&&(a=r)}),void 0===a)r=new n.Object3D;else{var i;i=void 0===a.LightType?0:a.LightType.value;var o=16777215;void 0!==a.Color&&(o=(new n.Color).fromArray(a.Color.value));var s=void 0===a.Intensity?1:a.Intensity.value/100;void 0!==a.CastLightOnObject&&0===a.CastLightOnObject.value&&(s=0);var l=0;void 0!==a.FarAttenuationEnd&&(l=void 0!==a.EnableFarAttenuation&&0===a.EnableFarAttenuation.value?0:a.FarAttenuationEnd.value);switch(i){case 0:r=new n.PointLight(o,s,l,1);break;case 1:r=new n.DirectionalLight(o,s);break;case 2:var c=Math.PI/3;void 0!==a.InnerAngle&&(c=n.Math.degToRad(a.InnerAngle.value));var u=0;void 0!==a.OuterAngle&&(u=n.Math.degToRad(a.OuterAngle.value),u=Math.max(u,1)),r=new n.SpotLight(o,s,l,c,u,1);break;default:console.warn("THREE.FBXLoader: Unknown light type "+a.LightType.value+", defaulting to a PointLight."),r=new n.PointLight(o,s)}void 0!==a.CastShadows&&1===a.CastShadows.value&&(r.castShadow=!0)}return r},createMesh:function(e,t,r){var a,i=null,o=null,s=[];return e.children.forEach(function(e){t.has(e.ID)&&(i=t.get(e.ID)),r.has(e.ID)&&s.push(r.get(e.ID))}),s.length>1?o=s:s.length>0?o=s[0]:(o=new n.MeshPhongMaterial({color:13421772}),s.push(o)),"color"in i.attributes&&s.forEach(function(e){e.vertexColors=n.VertexColors}),i.FBX_Deformer?(s.forEach(function(e){e.skinning=!0}),(a=new n.SkinnedMesh(i,o)).normalizeSkinWeights()):a=new n.Mesh(i,o),a},createCurve:function(e,t){var r=e.children.reduce(function(e,r){return t.has(r.ID)&&(e=t.get(r.ID)),e},null),a=new n.LineBasicMaterial({color:3342591,linewidth:1});return new n.Line(r,a)},getTransformData:function(e,t){var r={};"InheritType"in t&&(r.inheritType=parseInt(t.InheritType.value)),r.eulerOrder="RotationOrder"in t?b(t.RotationOrder.value):"ZYX","Lcl_Translation"in t&&(r.translation=t.Lcl_Translation.value),"PreRotation"in t&&(r.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(r.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(r.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(r.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(r.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(r.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(r.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(r.rotationPivot=t.RotationPivot.value),e.userData.transformData=r},setLookAtProperties:function(a,i){"LookAtProperty"in i&&t.get(a.ID).children.forEach(function(t){if("LookAtProperty"===t.relationship){var i=e.Objects.Model[t.ID];if("Lcl_Translation"in i){var o=i.Lcl_Translation.value;void 0!==a.target?(a.target.position.fromArray(o),r.add(a.target)):a.lookAt((new n.Vector3).fromArray(o))}}})},bindSkeleton:function(e,r,a){var i=this.parsePoseNodes();for(var o in e){var s=e[o];t.get(parseInt(s.ID)).parents.forEach(function(e){if(r.has(e.ID)){var o=e.ID;t.get(o).parents.forEach(function(e){a.has(e.ID)&&a.get(e.ID).bind(new n.Skeleton(s.bones),i[e.ID])})}})}},parsePoseNodes:function(){var t={};if("Pose"in e.Objects){var r=e.Objects.Pose;for(var a in r)if("BindPose"===r[a].attrType){var i=r[a].PoseNode;Array.isArray(i)?i.forEach(function(e){t[e.Node]=(new n.Matrix4).fromArray(e.Matrix.a)}):t[i.Node]=(new n.Matrix4).fromArray(i.Matrix.a)}}return t},createAmbientLight:function(){if("GlobalSettings"in e&&"AmbientColor"in e.GlobalSettings){var t=e.GlobalSettings.AmbientColor.value,a=t[0],i=t[1],o=t[2];if(0!==a||0!==i||0!==o){var s=new n.Color(a,i,o);r.add(new n.AmbientLight(s,1))}}},setupMorphMaterials:function(){var e=this;r.traverse(function(t){t.isMesh&&t.geometry.morphAttributes.position&&t.geometry.morphAttributes.position.length&&(Array.isArray(t.material)?t.material.forEach(function(r,n){e.setupMorphMaterial(t,r,n)}):e.setupMorphMaterial(t,t.material))})},setupMorphMaterial:function(e,t,n){var a=e.uuid,i=t.uuid,o=!1;if(r.traverse(function(e){e.isMesh&&(Array.isArray(e.material)?e.material.forEach(function(t){t.uuid===i&&e.uuid!==a&&(o=!0)}):e.material.uuid===i&&e.uuid!==a&&(o=!0))}),!0===o){var s=t.clone();s.morphTargets=!0,void 0===n?e.material=s:e.material[n]=s}else t.morphTargets=!0}},o.prototype={constructor:o,parse:function(r){var n=new Map;if("Geometry"in e.Objects){var a=e.Objects.Geometry;for(var i in a){var o=t.get(parseInt(i)),s=this.parseGeometry(o,a[i],r);n.set(parseInt(i),s)}}return n},parseGeometry:function(e,t,r){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,r);case"NurbsCurve":return this.parseNurbsGeometry(t)}},parseMeshGeometry:function(t,r,n){var a=n.skeletons,i=n.morphTargets,o=t.parents.map(function(t){return e.Objects.Model[t.ID]});if(0!==o.length){var s=t.children.reduce(function(e,t){return void 0!==a[t.ID]&&(e=a[t.ID]),e},null),l=t.children.reduce(function(e,t){return void 0!==i[t.ID]&&(e=i[t.ID]),e},null),c=o[0],u={};"RotationOrder"in c&&(u.eulerOrder=b(c.RotationOrder.value)),"InheritType"in c&&(u.inheritType=parseInt(c.InheritType.value)),"GeometricTranslation"in c&&(u.translation=c.GeometricTranslation.value),"GeometricRotation"in c&&(u.rotation=c.GeometricRotation.value),"GeometricScaling"in c&&(u.scale=c.GeometricScaling.value);var p=y(u);return this.genGeometry(r,s,l,p)}},genGeometry:function(e,t,r,a){var i=new n.BufferGeometry;e.attrName&&(i.name=e.attrName);var o=this.parseGeoNode(e,t),s=this.genBuffers(o),l=new n.Float32BufferAttribute(s.vertex,3);if(a.applyToBufferAttribute(l),i.addAttribute("position",l),s.colors.length>0&&i.addAttribute("color",new n.Float32BufferAttribute(s.colors,3)),t&&(i.addAttribute("skinIndex",new n.Uint16BufferAttribute(s.weightsIndices,4)),i.addAttribute("skinWeight",new n.Float32BufferAttribute(s.vertexWeights,4)),i.FBX_Deformer=t),s.normal.length>0){var c=new n.Float32BufferAttribute(s.normal,3);(new n.Matrix3).getNormalMatrix(a).applyToBufferAttribute(c),i.addAttribute("normal",c)}if(s.uvs.forEach(function(e,t){var r="uv"+(t+1).toString();0===t&&(r="uv"),i.addAttribute(r,new n.Float32BufferAttribute(s.uvs[t],2))}),o.material&&"AllSame"!==o.material.mappingType){var u=s.materialIndex[0],p=0;if(s.materialIndex.forEach(function(e,t){e!==u&&(i.addGroup(p,t-p,u),u=e,p=t)}),i.groups.length>0){var h=i.groups[i.groups.length-1],d=h.start+h.count;d!==s.materialIndex.length&&i.addGroup(d,s.materialIndex.length-d,u)}0===i.groups.length&&i.addGroup(0,s.materialIndex.length,s.materialIndex[0])}return this.addMorphTargets(i,e,r,a),i},parseGeoNode:function(e,t){var r={};if(r.vertexPositions=void 0!==e.Vertices?e.Vertices.a:[],r.vertexIndices=void 0!==e.PolygonVertexIndex?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(r.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(r.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(r.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){r.uv=[];for(var n=0;e.LayerElementUV[n];)r.uv.push(this.parseUVs(e.LayerElementUV[n])),n++}return r.weightTable={},null!==t&&(r.skeleton=t,t.rawBones.forEach(function(e,t){e.indices.forEach(function(n,a){void 0===r.weightTable[n]&&(r.weightTable[n]=[]),r.weightTable[n].push({id:t,weight:e.weights[a]})})})),r},genBuffers:function(e){var t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]},r=0,n=0,a=!1,i=[],o=[],s=[],l=[],c=[],u=[],p=this;return e.vertexIndices.forEach(function(h,d){var f=!1;h<0&&(h^=-1,f=!0);var v=[],g=[];if(i.push(3*h,3*h+1,3*h+2),e.color){var y=m(d,r,h,e.color);s.push(y[0],y[1],y[2])}if(e.skeleton){if(void 0!==e.weightTable[h]&&e.weightTable[h].forEach(function(e){g.push(e.weight),v.push(e.id)}),g.length>4){a||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),a=!0);var b=[0,0,0,0],w=[0,0,0,0];g.forEach(function(e,t){var r=e,n=v[t];w.forEach(function(e,t,a){if(r>e){a[t]=r,r=e;var i=b[t];b[t]=n,n=i}})}),v=b,g=w}for(;g.length<4;)g.push(0),v.push(0);for(var T=0;T<4;++T)c.push(g[T]),u.push(v[T])}if(e.normal){y=m(d,r,h,e.normal);o.push(y[0],y[1],y[2])}if(e.material&&"AllSame"!==e.material.mappingType)var E=m(d,r,h,e.material)[0];e.uv&&e.uv.forEach(function(e,t){var n=m(d,r,h,e);void 0===l[t]&&(l[t]=[]),l[t].push(n[0]),l[t].push(n[1])}),n++,f&&(p.genFace(t,e,i,E,o,s,l,c,u,n),r++,n=0,i=[],o=[],s=[],l=[],c=[],u=[])}),t},genFace:function(e,t,r,n,a,i,o,s,l,c){for(var u=2;u<c;u++)e.vertex.push(t.vertexPositions[r[0]]),e.vertex.push(t.vertexPositions[r[1]]),e.vertex.push(t.vertexPositions[r[2]]),e.vertex.push(t.vertexPositions[r[3*(u-1)]]),e.vertex.push(t.vertexPositions[r[3*(u-1)+1]]),e.vertex.push(t.vertexPositions[r[3*(u-1)+2]]),e.vertex.push(t.vertexPositions[r[3*u]]),e.vertex.push(t.vertexPositions[r[3*u+1]]),e.vertex.push(t.vertexPositions[r[3*u+2]]),t.skeleton&&(e.vertexWeights.push(s[0]),e.vertexWeights.push(s[1]),e.vertexWeights.push(s[2]),e.vertexWeights.push(s[3]),e.vertexWeights.push(s[4*(u-1)]),e.vertexWeights.push(s[4*(u-1)+1]),e.vertexWeights.push(s[4*(u-1)+2]),e.vertexWeights.push(s[4*(u-1)+3]),e.vertexWeights.push(s[4*u]),e.vertexWeights.push(s[4*u+1]),e.vertexWeights.push(s[4*u+2]),e.vertexWeights.push(s[4*u+3]),e.weightsIndices.push(l[0]),e.weightsIndices.push(l[1]),e.weightsIndices.push(l[2]),e.weightsIndices.push(l[3]),e.weightsIndices.push(l[4*(u-1)]),e.weightsIndices.push(l[4*(u-1)+1]),e.weightsIndices.push(l[4*(u-1)+2]),e.weightsIndices.push(l[4*(u-1)+3]),e.weightsIndices.push(l[4*u]),e.weightsIndices.push(l[4*u+1]),e.weightsIndices.push(l[4*u+2]),e.weightsIndices.push(l[4*u+3])),t.color&&(e.colors.push(i[0]),e.colors.push(i[1]),e.colors.push(i[2]),e.colors.push(i[3*(u-1)]),e.colors.push(i[3*(u-1)+1]),e.colors.push(i[3*(u-1)+2]),e.colors.push(i[3*u]),e.colors.push(i[3*u+1]),e.colors.push(i[3*u+2])),t.material&&"AllSame"!==t.material.mappingType&&(e.materialIndex.push(n),e.materialIndex.push(n),e.materialIndex.push(n)),t.normal&&(e.normal.push(a[0]),e.normal.push(a[1]),e.normal.push(a[2]),e.normal.push(a[3*(u-1)]),e.normal.push(a[3*(u-1)+1]),e.normal.push(a[3*(u-1)+2]),e.normal.push(a[3*u]),e.normal.push(a[3*u+1]),e.normal.push(a[3*u+2])),t.uv&&t.uv.forEach(function(t,r){void 0===e.uvs[r]&&(e.uvs[r]=[]),e.uvs[r].push(o[r][0]),e.uvs[r].push(o[r][1]),e.uvs[r].push(o[r][2*(u-1)]),e.uvs[r].push(o[r][2*(u-1)+1]),e.uvs[r].push(o[r][2*u]),e.uvs[r].push(o[r][2*u+1])})},addMorphTargets:function(t,r,n,a){if(null!==n){t.morphAttributes.position=[];var i=this;n.rawTargets.forEach(function(n){var o=e.Objects.Geometry[n.geoID];void 0!==o&&i.genMorphGeometry(t,r,o,a,n.name)})}},genMorphGeometry:function(e,t,r,a,i){var o=new n.BufferGeometry;r.attrName&&(o.name=r.attrName);for(var s=void 0!==t.PolygonVertexIndex?t.PolygonVertexIndex.a:[],l=void 0!==t.Vertices?t.Vertices.a.slice():[],c=void 0!==r.Vertices?r.Vertices.a:[],u=void 0!==r.Indexes?r.Indexes.a:[],p=0;p<u.length;p++){var h=3*u[p];l[h]+=c[3*p],l[h+1]+=c[3*p+1],l[h+2]+=c[3*p+2]}var d={vertexIndices:s,vertexPositions:l},f=this.genBuffers(d),m=new n.Float32BufferAttribute(f.vertex,3);m.name=i||r.attrName,a.applyToBufferAttribute(m),e.morphAttributes.position.push(m)},parseNormals:function(e){var t=e.MappingInformationType,r=e.ReferenceInformationType,n=e.Normals.a,a=[];return"IndexToDirect"===r&&("NormalIndex"in e?a=e.NormalIndex.a:"NormalsIndex"in e&&(a=e.NormalsIndex.a)),{dataSize:3,buffer:n,indices:a,mappingType:t,referenceType:r}},parseUVs:function(e){var t=e.MappingInformationType,r=e.ReferenceInformationType,n=e.UV.a,a=[];return"IndexToDirect"===r&&(a=e.UVIndex.a),{dataSize:2,buffer:n,indices:a,mappingType:t,referenceType:r}},parseVertexColors:function(e){var t=e.MappingInformationType,r=e.ReferenceInformationType,n=e.Colors.a,a=[];return"IndexToDirect"===r&&(a=e.ColorIndex.a),{dataSize:4,buffer:n,indices:a,mappingType:t,referenceType:r}},parseMaterialIndices:function(e){var t=e.MappingInformationType,r=e.ReferenceInformationType;if("NoMappingInformation"===t)return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:r};for(var n=e.Materials.a,a=[],i=0;i<n.length;++i)a.push(i);return{dataSize:1,buffer:n,indices:a,mappingType:t,referenceType:r}},parseNurbsGeometry:function(e){if(void 0===W)return console.error("THREE.FBXLoader: The loader relies on NURBSCurve for any nurbs present in the model. Nurbs will show up as empty geometry."),new n.BufferGeometry;var t=parseInt(e.Order);if(isNaN(t))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new n.BufferGeometry;for(var r,a,i=t-1,o=e.KnotVector.a,s=[],l=e.Points.a,c=0,u=l.length;c<u;c+=4)s.push((new n.Vector4).fromArray(l,c));if("Closed"===e.Form)s.push(s[0]);else if("Periodic"===e.Form){r=i,a=o.length-1-r;for(c=0;c<i;++c)s.push(s[c])}var p=new W(i,o,s,r,a).getPoints(7*s.length),h=new Float32Array(3*p.length);p.forEach(function(e,t){e.toArray(h,3*t)});var d=new n.BufferGeometry;return d.addAttribute("position",new n.BufferAttribute(h,3)),d}},s.prototype={constructor:s,parse:function(){var e=[],t=this.parseClips();if(void 0!==t)for(var r in t){var n=t[r],a=this.addClip(n);e.push(a)}return e},parseClips:function(){if(void 0!==e.Objects.AnimationCurve){var t=this.parseAnimationCurveNodes();this.parseAnimationCurves(t);var r=this.parseAnimationLayers(t);return this.parseAnimStacks(r)}},parseAnimationCurveNodes:function(){var t=e.Objects.AnimationCurveNode,r=new Map;for(var n in t){var a=t[n];if(null!==a.attrName.match(/S|R|T|DeformPercent/)){var i={id:a.id,attr:a.attrName,curves:{}};r.set(i.id,i)}}return r},parseAnimationCurves:function(r){var n=e.Objects.AnimationCurve;for(var a in n){var i={id:n[a].id,times:n[a].KeyTime.a.map(d),values:n[a].KeyValueFloat.a},o=t.get(i.id);if(void 0!==o){var s=o.parents[0].ID,l=o.parents[0].relationship;l.match(/X/)?r.get(s).curves.x=i:l.match(/Y/)?r.get(s).curves.y=i:l.match(/Z/)?r.get(s).curves.z=i:l.match(/d|DeformPercent/)&&r.has(s)&&(r.get(s).curves.morph=i)}}},parseAnimationLayers:function(a){var i=e.Objects.AnimationLayer,o=new Map;for(var s in i){var l=[],c=t.get(parseInt(s));if(void 0!==c)c.children.forEach(function(i,o){if(a.has(i.ID)){var s=a.get(i.ID);if(void 0!==s.curves.x||void 0!==s.curves.y||void 0!==s.curves.z){if(void 0===l[o])if(void 0!==(f=t.get(i.ID).parents.filter(function(e){return void 0!==e.relationship})[0].ID)){var c=e.Objects.Model[f.toString()],u={modelName:n.PropertyBinding.sanitizeNodeName(c.attrName),ID:c.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};r.traverse(function(e){e.ID===c.id&&(u.transform=e.matrix,e.userData.transformData&&(u.eulerOrder=e.userData.transformData.eulerOrder))}),u.transform||(u.transform=new n.Matrix4),"PreRotation"in c&&(u.preRotation=c.PreRotation.value),"PostRotation"in c&&(u.postRotation=c.PostRotation.value),l[o]=u}l[o]&&(l[o][s.attr]=s)}else if(void 0!==s.curves.morph){if(void 0===l[o]){var p=t.get(i.ID).parents.filter(function(e){return void 0!==e.relationship})[0].ID,h=t.get(p).parents[0].ID,d=t.get(h).parents[0].ID,f=t.get(d).parents[0].ID;c=e.Objects.Model[f],u={modelName:n.PropertyBinding.sanitizeNodeName(c.attrName),morphName:e.Objects.Deformer[p].attrName};l[o]=u}l[o][s.attr]=s}}}),o.set(parseInt(s),l)}return o},parseAnimStacks:function(r){var n=e.Objects.AnimationStack,a={};for(var i in n){var o=t.get(parseInt(i)).children;o.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");var s=r.get(o[0].ID);a[i]={name:n[i].attrName,layer:s}}return a},addClip:function(e){var t=[],r=this;return e.layer.forEach(function(e){t=t.concat(r.generateTracks(e))}),new n.AnimationClip(e.name,-1,t)},generateTracks:function(e){var t=[],r=new n.Vector3,a=new n.Quaternion,i=new n.Vector3;if(e.transform&&e.transform.decompose(r,a,i),r=r.toArray(),a=(new n.Euler).setFromQuaternion(a,e.eulerOrder).toArray(),i=i.toArray(),void 0!==e.T&&Object.keys(e.T.curves).length>0){var o=this.generateVectorTrack(e.modelName,e.T.curves,r,"position");void 0!==o&&t.push(o)}if(void 0!==e.R&&Object.keys(e.R.curves).length>0){var s=this.generateRotationTrack(e.modelName,e.R.curves,a,e.preRotation,e.postRotation,e.eulerOrder);void 0!==s&&t.push(s)}if(void 0!==e.S&&Object.keys(e.S.curves).length>0){var l=this.generateVectorTrack(e.modelName,e.S.curves,i,"scale");void 0!==l&&t.push(l)}if(void 0!==e.DeformPercent){var c=this.generateMorphTrack(e);void 0!==c&&t.push(c)}return t},generateVectorTrack:function(e,t,r,a){var i=this.getTimesForAllAxes(t),o=this.getKeyframeTrackValues(i,t,r);return new n.VectorKeyframeTrack(e+"."+a,i,o)},generateRotationTrack:function(e,t,r,a,i,o){void 0!==t.x&&(this.interpolateRotations(t.x),t.x.values=t.x.values.map(n.Math.degToRad)),void 0!==t.y&&(this.interpolateRotations(t.y),t.y.values=t.y.values.map(n.Math.degToRad)),void 0!==t.z&&(this.interpolateRotations(t.z),t.z.values=t.z.values.map(n.Math.degToRad));var s=this.getTimesForAllAxes(t),l=this.getKeyframeTrackValues(s,t,r);void 0!==a&&((a=a.map(n.Math.degToRad)).push(o),a=(new n.Euler).fromArray(a),a=(new n.Quaternion).setFromEuler(a)),void 0!==i&&((i=i.map(n.Math.degToRad)).push(o),i=(new n.Euler).fromArray(i),i=(new n.Quaternion).setFromEuler(i).inverse());for(var c=new n.Quaternion,u=new n.Euler,p=[],h=0;h<l.length;h+=3)u.set(l[h],l[h+1],l[h+2],o),c.setFromEuler(u),void 0!==a&&c.premultiply(a),void 0!==i&&c.multiply(i),c.toArray(p,h/3*4);return new n.QuaternionKeyframeTrack(e+".quaternion",s,p)},generateMorphTrack:function(e){var t=e.DeformPercent.curves.morph,a=t.values.map(function(e){return e/100}),i=r.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new n.NumberKeyframeTrack(e.modelName+".morphTargetInfluences["+i+"]",t.times,a)},getTimesForAllAxes:function(e){var t=[];return void 0!==e.x&&(t=t.concat(e.x.times)),void 0!==e.y&&(t=t.concat(e.y.times)),void 0!==e.z&&(t=t.concat(e.z.times)),t=t.sort(function(e,t){return e-t}).filter(function(e,t,r){return r.indexOf(e)==t})},getKeyframeTrackValues:function(e,t,r){var n=r,a=[],i=-1,o=-1,s=-1;return e.forEach(function(e){if(t.x&&(i=t.x.times.indexOf(e)),t.y&&(o=t.y.times.indexOf(e)),t.z&&(s=t.z.times.indexOf(e)),-1!==i){var r=t.x.values[i];a.push(r),n[0]=r}else a.push(n[0]);if(-1!==o){var l=t.y.values[o];a.push(l),n[1]=l}else a.push(n[1]);if(-1!==s){var c=t.z.values[s];a.push(c),n[2]=c}else a.push(n[2])}),a},interpolateRotations:function(e){for(var t=1;t<e.values.length;t++){var r=e.values[t-1],n=e.values[t]-r,a=Math.abs(n);if(a>=180){for(var i=a/180,o=n/i,s=r+o,l=e.times[t-1],c=(e.times[t]-l)/i,u=l+c,p=[],h=[];u<e.times[t];)p.push(u),u+=c,h.push(s),s+=o;e.times=E(e.times,t,p),e.values=E(e.values,t,h)}}}},l.prototype={constructor:l,getPrevNode:function(){return this.nodeStack[this.currentIndent-2]},getCurrentNode:function(){return this.nodeStack[this.currentIndent-1]},getCurrentProp:function(){return this.currentProp},pushStack:function(e){this.nodeStack.push(e),this.currentIndent+=1},popStack:function(){this.nodeStack.pop(),this.currentIndent-=1},setCurrentProp:function(e,t){this.currentProp=e,this.currentPropName=t},parse:function(e){this.currentIndent=0,this.allNodes=new p,this.nodeStack=[],this.currentProp=[],this.currentPropName="";var t=this,r=e.split(/[\r\n]+/);return r.forEach(function(e,n){var a=e.match(/^[\s\t]*;/),i=e.match(/^[\s\t]*$/);if(!a&&!i){var o=e.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),s=e.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),l=e.match("^\\t{"+(t.currentIndent-1)+"}}");o?t.parseNodeBegin(e,o):s?t.parseNodeProperty(e,s,r[++n]):l?t.popStack():e.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(e)}}),this.allNodes},parseNodeBegin:function(e,t){var r=t[1].trim().replace(/^"/,"").replace(/"$/,""),n=t[2].split(",").map(function(e){return e.trim().replace(/^"/,"").replace(/"$/,"")}),a={name:r},i=this.parseNodeAttr(n),o=this.getCurrentNode();0===this.currentIndent?this.allNodes.add(r,a):r in o?("PoseNode"===r?o.PoseNode.push(a):void 0!==o[r].id&&(o[r]={},o[r][o[r].id]=o[r]),""!==i.id&&(o[r][i.id]=a)):"number"===typeof i.id?(o[r]={},o[r][i.id]=a):"Properties70"!==r&&(o[r]="PoseNode"===r?[a]:a),"number"===typeof i.id&&(a.id=i.id),""!==i.name&&(a.attrName=i.name),""!==i.type&&(a.attrType=i.type),this.pushStack(a)},parseNodeAttr:function(e){var t=e[0];""!==e[0]&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));var r="",n="";return e.length>1&&(r=e[1].replace(/^(\w+)::/,""),n=e[2]),{id:t,name:r,type:n}},parseNodeProperty:function(e,t,r){var n=t[1].replace(/^"/,"").replace(/"$/,"").trim(),a=t[2].replace(/^"/,"").replace(/"$/,"").trim();"Content"===n&&","===a&&(a=r.replace(/"/g,"").replace(/,$/,"").trim());var i=this.getCurrentNode();if("Properties70"!==i.name){if("C"===n){var o=a.split(",").slice(1),s=parseInt(o[0]),l=parseInt(o[1]),c=a.split(",").slice(3);n="connections",function(e,t){for(var r=0,n=e.length,a=t.length;r<a;r++,n++)e[n]=t[r]}(a=[s,l],c=c.map(function(e){return e.trim().replace(/^"/,"")})),void 0===i[n]&&(i[n]=[])}"Node"===n&&(i.id=a),n in i&&Array.isArray(i[n])?i[n].push(a):"a"!==n?i[n]=a:i.a=a,this.setCurrentProp(i,n),"a"===n&&","!==a.slice(-1)&&(i.a=w(a))}else this.parseNodeSpecialProperty(e,n,a)},parseNodePropertyContinued:function(e){var t=this.getCurrentNode();t.a+=e,","!==e.slice(-1)&&(t.a=w(t.a))},parseNodeSpecialProperty:function(e,t,r){var n=r.split('",').map(function(e){return e.trim().replace(/^\"/,"").replace(/\s/,"_")}),a=n[0],i=n[1],o=n[2],s=n[3],l=n[4];switch(i){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":l=parseFloat(l);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":l=w(l)}this.getPrevNode()[a]={type:i,type2:o,flag:s,value:l},this.setCurrentProp(this.getPrevNode(),a)}},c.prototype={constructor:c,parse:function(e){var t=new u(e);t.skip(23);var r=t.getUint32();console.log("THREE.FBXLoader: FBX binary version: "+r);for(var n=new p;!this.endOfContent(t);){var a=this.parseNode(t,r);null!==a&&n.add(a.name,a)}return n},endOfContent:function(e){return e.size()%16===0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()},parseNode:function(e,t){var r={},n=t>=7500?e.getUint64():e.getUint32(),a=t>=7500?e.getUint64():e.getUint32(),i=(t>=7500?e.getUint64():e.getUint32(),e.getUint8()),o=e.getString(i);if(0===n)return null;for(var s=[],l=0;l<a;l++)s.push(this.parseProperty(e));var c=s.length>0?s[0]:"",u=s.length>1?s[1]:"",p=s.length>2?s[2]:"";for(r.singleProperty=1===a&&e.getOffset()===n;n>e.getOffset();){var h=this.parseNode(e,t);null!==h&&this.parseSubNode(o,r,h)}return r.propertyList=s,"number"===typeof c&&(r.id=c),""!==u&&(r.attrName=u),""!==p&&(r.attrType=p),""!==o&&(r.name=o),r},parseSubNode:function(e,t,r){if(!0===r.singleProperty){var n=r.propertyList[0];Array.isArray(n)?(t[r.name]=r,r.a=n):t[r.name]=n}else if("Connections"===e&&"C"===r.name){var a=[];r.propertyList.forEach(function(e,t){0!==t&&a.push(e)}),void 0===t.connections&&(t.connections=[]),t.connections.push(a)}else if("Properties70"===r.name){Object.keys(r).forEach(function(e){t[e]=r[e]})}else if("Properties70"===e&&"P"===r.name){var i,o=r.propertyList[0],s=r.propertyList[1],l=r.propertyList[2],c=r.propertyList[3];0===o.indexOf("Lcl ")&&(o=o.replace("Lcl ","Lcl_")),0===s.indexOf("Lcl ")&&(s=s.replace("Lcl ","Lcl_")),i="Color"===s||"ColorRGB"===s||"Vector"===s||"Vector3D"===s||0===s.indexOf("Lcl_")?[r.propertyList[4],r.propertyList[5],r.propertyList[6]]:r.propertyList[4],t[o]={type:s,type2:l,flag:c,value:i}}else void 0===t[r.name]?"number"===typeof r.id?(t[r.name]={},t[r.name][r.id]=r):t[r.name]=r:"PoseNode"===r.name?(Array.isArray(t[r.name])||(t[r.name]=[t[r.name]]),t[r.name].push(r)):void 0===t[r.name][r.id]&&(t[r.name][r.id]=r)},parseProperty:function(e){var t=e.getString(1);switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":var r=e.getUint32();return e.getArrayBuffer(r);case"S":r=e.getUint32();return e.getString(r);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":var n=e.getUint32(),a=e.getUint32(),i=e.getUint32();if(0===a)switch(t){case"b":case"c":return e.getBooleanArray(n);case"d":return e.getFloat64Array(n);case"f":return e.getFloat32Array(n);case"i":return e.getInt32Array(n);case"l":return e.getInt64Array(n)}"undefined"===typeof z&&console.error("THREE.FBXLoader: External library Inflate.min.js required, obtain or import from https://github.com/imaya/zlib.js");var o=new u(new z.Inflate(new Uint8Array(e.getArrayBuffer(i))).decompress().buffer);switch(t){case"b":case"c":return o.getBooleanArray(n);case"d":return o.getFloat64Array(n);case"f":return o.getFloat32Array(n);case"i":return o.getInt32Array(n);case"l":return o.getInt64Array(n)}default:throw new Error("THREE.FBXLoader: Unknown property type "+t)}}},u.prototype={constructor:u,getOffset:function(){return this.offset},size:function(){return this.dv.buffer.byteLength},skip:function(e){this.offset+=e},getBoolean:function(){return 1===(1&this.getUint8())},getBooleanArray:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getBoolean());return t},getUint8:function(){var e=this.dv.getUint8(this.offset);return this.offset+=1,e},getInt16:function(){var e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e},getInt32:function(){var e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e},getInt32Array:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getInt32());return t},getUint32:function(){var e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e},getInt64:function(){var e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),2147483648&t?(t=4294967295&~t,4294967295===(e=4294967295&~e)&&(t=t+1&4294967295),-(4294967296*t+(e=e+1&4294967295))):4294967296*t+e},getInt64Array:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getInt64());return t},getUint64:function(){var e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),4294967296*t+e},getFloat32:function(){var e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e},getFloat32Array:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getFloat32());return t},getFloat64:function(){var e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e},getFloat64Array:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getFloat64());return t},getArrayBuffer:function(e){var t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t},getString:function(e){for(var t=[],r=0;r<e;r++)t[r]=this.getUint8();var a=t.indexOf(0);return a>=0&&(t=t.slice(0,a)),n.LoaderUtils.decodeText(new Uint8Array(t))}},p.prototype={constructor:p,add:function(e,t){this[e]=t}};var f=[];function m(e,t,r,n){var a;switch(n.mappingType){case"ByPolygonVertex":a=e;break;case"ByPolygon":a=t;break;case"ByVertice":a=r;break;case"AllSame":a=n.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+n.mappingType)}"IndexToDirect"===n.referenceType&&(a=n.indices[a]);var i=a*n.dataSize,o=i+n.dataSize;return function(e,t,r,n){for(var a=r,i=0;a<n;a++,i++)e[i]=t[a];return e}(f,n.buffer,i,o)}var v=new n.Euler,g=new n.Vector3;function y(e){var t,r=new n.Matrix4,a=new n.Matrix4,i=new n.Matrix4,o=new n.Matrix4,s=new n.Matrix4,l=new n.Matrix4,c=new n.Matrix4,u=new n.Matrix4,p=new n.Matrix4,h=new n.Matrix4,d=new n.Matrix4,f=e.inheritType?e.inheritType:0;(e.translation&&r.setPosition(g.fromArray(e.translation)),e.preRotation)&&((t=e.preRotation.map(n.Math.degToRad)).push(e.eulerOrder),a.makeRotationFromEuler(v.fromArray(t)));e.rotation&&((t=e.rotation.map(n.Math.degToRad)).push(e.eulerOrder),i.makeRotationFromEuler(v.fromArray(t)));e.postRotation&&((t=e.postRotation.map(n.Math.degToRad)).push(e.eulerOrder),o.makeRotationFromEuler(v.fromArray(t)));e.scale&&s.scale(g.fromArray(e.scale)),e.scalingOffset&&c.setPosition(g.fromArray(e.scalingOffset)),e.scalingPivot&&l.setPosition(g.fromArray(e.scalingPivot)),e.rotationOffset&&u.setPosition(g.fromArray(e.rotationOffset)),e.rotationPivot&&p.setPosition(g.fromArray(e.rotationPivot)),e.parentMatrixWorld&&(h=e.parentMatrixWorld);var m=a.multiply(i).multiply(o),y=new n.Matrix4;h.extractRotation(y);var b,w,T,E,M=new n.Matrix4;if(M.copyPosition(h),T=M.getInverse(M).multiply(h),w=y.getInverse(y).multiply(T),b=s,0===f)E=y.multiply(m).multiply(w).multiply(b);else if(1===f)E=y.multiply(w).multiply(m).multiply(b);else{var S=(new n.Matrix4).copy(s),x=w.multiply(S.getInverse(S));E=y.multiply(m).multiply(x).multiply(b)}var A=r.multiply(u).multiply(p).multiply(a).multiply(i).multiply(o).multiply(p.getInverse(p)).multiply(c).multiply(l).multiply(s).multiply(l.getInverse(l)),L=(new n.Matrix4).copyPosition(A),R=h.multiply(L);return d.copyPosition(R),A=d.multiply(E)}function b(e){var t=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return 6===(e=e||0)?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),t[0]):t[e]}function w(e){return e.split(",").map(function(e){return parseFloat(e)})}function T(e,t,r){return void 0===t&&(t=0),void 0===r&&(r=e.byteLength),n.LoaderUtils.decodeText(new Uint8Array(e,t,r))}function E(e,t,r){return e.slice(0,t).concat(r).concat(e.slice(t))}return a}();!function(){function e(e){this.manager=void 0!==e?e:n.DefaultLoadingManager,this.dracoLoader=null,this.ddsLoader=null}function t(){var e={};return{get:function(t){return e[t]},add:function(t,r){e[t]=r},remove:function(t){delete e[t]},removeAll:function(){e={}}}}e.prototype={constructor:e,crossOrigin:"anonymous",load:function(e,t,r,a){var i,o=this;i=void 0!==this.resourcePath?this.resourcePath:void 0!==this.path?this.path:n.LoaderUtils.extractUrlBase(e),o.manager.itemStart(e);var s=function(t){a?a(t):console.error(t),o.manager.itemError(e),o.manager.itemEnd(e)},l=new n.FileLoader(o.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),"use-credentials"===o.crossOrigin&&l.setWithCredentials(!0),l.load(e,function(r){try{o.parse(r,i,function(r){t(r),o.manager.itemEnd(e)},s)}catch(n){s(n)}},r,s)},setCrossOrigin:function(e){return this.crossOrigin=e,this},setPath:function(e){return this.path=e,this},setResourcePath:function(e){return this.resourcePath=e,this},setDRACOLoader:function(e){return this.dracoLoader=e,this},setDDSLoader:function(e){return this.ddsLoader=e,this},parse:function(e,t,l,c){var f,m={};if("string"===typeof e)f=e;else if(n.LoaderUtils.decodeText(new Uint8Array(e,0,4))===s){try{m[r.KHR_BINARY_GLTF]=new u(e)}catch(w){return void(c&&c(w))}f=m[r.KHR_BINARY_GLTF].content}else f=n.LoaderUtils.decodeText(new Uint8Array(e));var v=JSON.parse(f);if(void 0===v.asset||v.asset.version[0]<2)c&&c(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported. Use LegacyGLTFLoader instead."));else{if(v.extensionsUsed)for(var g=0;g<v.extensionsUsed.length;++g){var y=v.extensionsUsed[g],b=v.extensionsRequired||[];switch(y){case r.KHR_LIGHTS_PUNCTUAL:m[y]=new i(v);break;case r.KHR_MATERIALS_UNLIT:m[y]=new o;break;case r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:m[y]=new d;break;case r.KHR_DRACO_MESH_COMPRESSION:m[y]=new p(v,this.dracoLoader);break;case r.MSFT_TEXTURE_DDS:m[r.MSFT_TEXTURE_DDS]=new a(this.ddsLoader);break;case r.KHR_TEXTURE_TRANSFORM:m[r.KHR_TEXTURE_TRANSFORM]=new h;break;default:b.indexOf(y)>=0&&console.warn('THREE.GLTFLoader: Unknown extension "'+y+'".')}}new G(v,m,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,manager:this.manager}).parse(l,c)}}};var r={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",MSFT_TEXTURE_DDS:"MSFT_texture_dds"};function a(e){if(!e)throw new Error("THREE.GLTFLoader: Attempting to load .dds texture without importing DDSLoader");this.name=r.MSFT_TEXTURE_DDS,this.ddsLoader=e}function i(e){this.name=r.KHR_LIGHTS_PUNCTUAL;var t=e.extensions&&e.extensions[r.KHR_LIGHTS_PUNCTUAL]||{};this.lightDefs=t.lights||[]}function o(){this.name=r.KHR_MATERIALS_UNLIT}i.prototype.loadLight=function(e){var t,r=this.lightDefs[e],a=new n.Color(16777215);void 0!==r.color&&a.fromArray(r.color);var i=void 0!==r.range?r.range:0;switch(r.type){case"directional":(t=new n.DirectionalLight(a)).target.position.set(0,0,-1),t.add(t.target);break;case"point":(t=new n.PointLight(a)).distance=i;break;case"spot":(t=new n.SpotLight(a)).distance=i,r.spot=r.spot||{},r.spot.innerConeAngle=void 0!==r.spot.innerConeAngle?r.spot.innerConeAngle:0,r.spot.outerConeAngle=void 0!==r.spot.outerConeAngle?r.spot.outerConeAngle:Math.PI/4,t.angle=r.spot.outerConeAngle,t.penumbra=1-r.spot.innerConeAngle/r.spot.outerConeAngle,t.target.position.set(0,0,-1),t.add(t.target);break;default:throw new Error('THREE.GLTFLoader: Unexpected light type, "'+r.type+'".')}return t.position.set(0,0,0),t.decay=2,void 0!==r.intensity&&(t.intensity=r.intensity),t.name=r.name||"light_"+e,Promise.resolve(t)},o.prototype.getMaterialType=function(){return n.MeshBasicMaterial},o.prototype.extendParams=function(e,t,r){var a=[];e.color=new n.Color(1,1,1),e.opacity=1;var i=t.pbrMetallicRoughness;if(i){if(Array.isArray(i.baseColorFactor)){var o=i.baseColorFactor;e.color.fromArray(o),e.opacity=o[3]}void 0!==i.baseColorTexture&&a.push(r.assignTexture(e,"map",i.baseColorTexture))}return Promise.all(a)};var s="glTF",l=12,c={JSON:1313821514,BIN:5130562};function u(e){this.name=r.KHR_BINARY_GLTF,this.content=null,this.body=null;var t=new DataView(e,0,l);if(this.header={magic:n.LoaderUtils.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==s)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected. Use LegacyGLTFLoader instead.");for(var a=new DataView(e,l),i=0;i<a.byteLength;){var o=a.getUint32(i,!0);i+=4;var u=a.getUint32(i,!0);if(i+=4,u===c.JSON){var p=new Uint8Array(e,l+i,o);this.content=n.LoaderUtils.decodeText(p)}else if(u===c.BIN){var h=l+i;this.body=e.slice(h,h+o)}i+=o}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}function p(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=r.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t}function h(){this.name=r.KHR_TEXTURE_TRANSFORM}function d(){return{name:r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,specularGlossinessParams:["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"],getMaterialType:function(){return n.ShaderMaterial},extendParams:function(e,t,r){var a=t.extensions[this.name],i=n.ShaderLib.standard,o=n.UniformsUtils.clone(i.uniforms),s=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),l=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),c=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),u=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),p=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb;","material.specularRoughness = clamp( 1.0 - glossinessFactor, 0.04, 1.0 );","material.specularColor = specularFactor.rgb;"].join("\n"),h=i.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",s).replace("#include <metalnessmap_pars_fragment>",l).replace("#include <roughnessmap_fragment>",c).replace("#include <metalnessmap_fragment>",u).replace("#include <lights_physical_fragment>",p);delete o.roughness,delete o.metalness,delete o.roughnessMap,delete o.metalnessMap,o.specular={value:(new n.Color).setHex(1118481)},o.glossiness={value:.5},o.specularMap={value:null},o.glossinessMap={value:null},e.vertexShader=i.vertexShader,e.fragmentShader=h,e.uniforms=o,e.defines={STANDARD:""},e.color=new n.Color(1,1,1),e.opacity=1;var d=[];if(Array.isArray(a.diffuseFactor)){var f=a.diffuseFactor;e.color.fromArray(f),e.opacity=f[3]}if(void 0!==a.diffuseTexture&&d.push(r.assignTexture(e,"map",a.diffuseTexture)),e.emissive=new n.Color(0,0,0),e.glossiness=void 0!==a.glossinessFactor?a.glossinessFactor:1,e.specular=new n.Color(1,1,1),Array.isArray(a.specularFactor)&&e.specular.fromArray(a.specularFactor),void 0!==a.specularGlossinessTexture){var m=a.specularGlossinessTexture;d.push(r.assignTexture(e,"glossinessMap",m)),d.push(r.assignTexture(e,"specularMap",m))}return Promise.all(d)},createMaterial:function(e){var t=new n.ShaderMaterial({defines:e.defines,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:e.uniforms,fog:!0,lights:!0,opacity:e.opacity,transparent:e.transparent});return t.isGLTFSpecularGlossinessMaterial=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=1,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t.refractionRatio=.98,t.extensions.derivatives=!0,t},cloneMaterial:function(e){var t=e.clone();t.isGLTFSpecularGlossinessMaterial=!0;for(var r=this.specularGlossinessParams,n=0,a=r.length;n<a;n++){var i=e[r[n]];t[r[n]]=i&&i.isColor?i.clone():i}return t},refreshUniforms:function(e,t,r,n,a){if(!0===a.isGLTFSpecularGlossinessMaterial){var i,o=a.uniforms,s=a.defines;o.opacity.value=a.opacity,o.diffuse.value.copy(a.color),o.emissive.value.copy(a.emissive).multiplyScalar(a.emissiveIntensity),o.map.value=a.map,o.specularMap.value=a.specularMap,o.alphaMap.value=a.alphaMap,o.lightMap.value=a.lightMap,o.lightMapIntensity.value=a.lightMapIntensity,o.aoMap.value=a.aoMap,o.aoMapIntensity.value=a.aoMapIntensity,a.map?i=a.map:a.specularMap?i=a.specularMap:a.displacementMap?i=a.displacementMap:a.normalMap?i=a.normalMap:a.bumpMap?i=a.bumpMap:a.glossinessMap?i=a.glossinessMap:a.alphaMap?i=a.alphaMap:a.emissiveMap&&(i=a.emissiveMap),void 0!==i&&(i.isWebGLRenderTarget&&(i=i.texture),!0===i.matrixAutoUpdate&&i.updateMatrix(),o.uvTransform.value.copy(i.matrix)),a.envMap&&(o.envMap.value=a.envMap,o.envMapIntensity.value=a.envMapIntensity,o.flipEnvMap.value=a.envMap.isCubeTexture?-1:1,o.reflectivity.value=a.reflectivity,o.refractionRatio.value=a.refractionRatio,o.maxMipLevel.value=e.properties.get(a.envMap).__maxMipLevel),o.specular.value.copy(a.specular),o.glossiness.value=a.glossiness,o.glossinessMap.value=a.glossinessMap,o.emissiveMap.value=a.emissiveMap,o.bumpMap.value=a.bumpMap,o.normalMap.value=a.normalMap,o.displacementMap.value=a.displacementMap,o.displacementScale.value=a.displacementScale,o.displacementBias.value=a.displacementBias,null!==o.glossinessMap.value&&void 0===s.USE_GLOSSINESSMAP&&(s.USE_GLOSSINESSMAP="",s.USE_ROUGHNESSMAP=""),null===o.glossinessMap.value&&void 0!==s.USE_GLOSSINESSMAP&&(delete s.USE_GLOSSINESSMAP,delete s.USE_ROUGHNESSMAP)}}}}function f(e,t,r,a){n.Interpolant.call(this,e,t,r,a)}p.prototype.decodePrimitive=function(e,t){var r=this.json,n=this.dracoLoader,a=e.extensions[this.name].bufferView,i=e.extensions[this.name].attributes,o={},s={},l={};for(var c in i){var u=L[c]||c.toLowerCase();o[u]=i[c]}for(c in e.attributes){u=L[c]||c.toLowerCase();if(void 0!==i[c]){var p=r.accessors[e.attributes[c]],h=M[p.componentType];l[u]=h,s[u]=!0===p.normalized}}return t.getDependency("bufferView",a).then(function(e){return new Promise(function(t){n.decodeDracoFile(e,function(e){for(var r in e.attributes){var n=e.attributes[r],a=s[r];void 0!==a&&(n.normalized=a)}t(e)},o,l)})})},h.prototype.extendTexture=function(e,t){return e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),void 0!==t.texCoord&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),e.needsUpdate=!0,e},f.prototype=Object.create(n.Interpolant.prototype),f.prototype.constructor=f,f.prototype.copySampleValue_=function(e){for(var t=this.resultBuffer,r=this.sampleValues,n=this.valueSize,a=e*n*3+n,i=0;i!==n;i++)t[i]=r[a+i];return t},f.prototype.beforeStart_=f.prototype.copySampleValue_,f.prototype.afterEnd_=f.prototype.copySampleValue_,f.prototype.interpolate_=function(e,t,r,n){for(var a=this.resultBuffer,i=this.sampleValues,o=this.valueSize,s=2*o,l=3*o,c=n-t,u=(r-t)/c,p=u*u,h=p*u,d=e*l,f=d-l,m=-2*h+3*p,v=h-p,g=1-m,y=v-p+u,b=0;b!==o;b++){var w=i[f+b+o],T=i[f+b+s]*c,E=i[d+b+o],M=i[d+b]*c;a[b]=g*w+y*T+m*E+v*M}return a};var m,v=0,g=1,y=2,b=3,w=4,T=5,E=6,M={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},S={9728:n.NearestFilter,9729:n.LinearFilter,9984:n.NearestMipMapNearestFilter,9985:n.LinearMipMapNearestFilter,9986:n.NearestMipMapLinearFilter,9987:n.LinearMipMapLinearFilter},x={33071:n.ClampToEdgeWrapping,33648:n.MirroredRepeatWrapping,10497:n.RepeatWrapping},A={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},L={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},R={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},I={CUBICSPLINE:void 0,LINEAR:n.InterpolateLinear,STEP:n.InterpolateDiscrete},_="OPAQUE",P="MASK",O="BLEND",C={"image/png":n.RGBAFormat,"image/jpeg":n.RGBFormat};function D(e,t){return"string"!==typeof e||""===e?"":/^(https?:)?\/\//i.test(e)?e:/^data:.*,.*$/i.test(e)?e:/^blob:.*$/i.test(e)?e:t+e}function k(e,t,r){for(var n in r.extensions)void 0===e[n]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[n]=r.extensions[n])}function N(e,t){void 0!==t.extras&&("object"===typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function F(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(var r=0,n=t.weights.length;r<n;r++)e.morphTargetInfluences[r]=t.weights[r];if(t.extras&&Array.isArray(t.extras.targetNames)){var a=t.extras.targetNames;if(e.morphTargetInfluences.length===a.length){e.morphTargetDictionary={};for(r=0,n=a.length;r<n;r++)e.morphTargetDictionary[a[r]]=r}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function U(e){var t=e.extensions&&e.extensions[r.KHR_DRACO_MESH_COMPRESSION];return t?"draco:"+t.bufferView+":"+t.indices+":"+B(t.attributes):e.indices+":"+B(e.attributes)+":"+e.mode}function B(e){for(var t="",r=Object.keys(e).sort(),n=0,a=r.length;n<a;n++)t+=r[n]+":"+e[r[n]]+";";return t}function j(e){if(e.isInterleavedBufferAttribute){for(var t=e.count,r=e.itemSize,a=e.array.slice(0,t*r),i=0,o=0;i<t;++i)a[o++]=e.getX(i),r>=2&&(a[o++]=e.getY(i)),r>=3&&(a[o++]=e.getZ(i)),r>=4&&(a[o++]=e.getW(i));return new n.BufferAttribute(a,r,e.normalized)}return e.clone()}function G(e,r,a){this.json=e||{},this.extensions=r||{},this.options=a||{},this.cache=new t,this.primitiveCache={},this.textureLoader=new n.TextureLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.fileLoader=new n.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}function H(e,t,r){var n=t.attributes,a=[];function i(t,n){return r.getDependency("accessor",t).then(function(t){e.addAttribute(n,t)})}for(var o in n){var s=L[o]||o.toLowerCase();s in e.attributes||a.push(i(n[o],s))}if(void 0!==t.indices&&!e.index){var l=r.getDependency("accessor",t.indices).then(function(t){e.setIndex(t)});a.push(l)}return N(e,t),Promise.all(a).then(function(){return void 0!==t.targets?function(e,t,r){for(var n=!1,a=!1,i=0,o=t.length;i<o&&(void 0!==(c=t[i]).POSITION&&(n=!0),void 0!==c.NORMAL&&(a=!0),!n||!a);i++);if(!n&&!a)return Promise.resolve(e);var s=[],l=[];for(i=0,o=t.length;i<o;i++){var c=t[i];if(n){var u=void 0!==c.POSITION?r.getDependency("accessor",c.POSITION):e.attributes.position;s.push(u)}a&&(u=void 0!==c.NORMAL?r.getDependency("accessor",c.NORMAL):e.attributes.normal,l.push(u))}return Promise.all([Promise.all(s),Promise.all(l)]).then(function(r){for(var i=r[0],o=r[1],s=0,l=i.length;s<l;s++)e.attributes.position!==i[s]&&(i[s]=j(i[s]));for(s=0,l=o.length;s<l;s++)e.attributes.normal!==o[s]&&(o[s]=j(o[s]));for(s=0,l=t.length;s<l;s++){var c=t[s],u="morphTarget"+s;if(n&&void 0!==c.POSITION){var p=i[s];p.name=u;for(var h=e.attributes.position,d=0,f=p.count;d<f;d++)p.setXYZ(d,p.getX(d)+h.getX(d),p.getY(d)+h.getY(d),p.getZ(d)+h.getZ(d))}if(a&&void 0!==c.NORMAL){var m=o[s];m.name=u;var v=e.attributes.normal;for(d=0,f=m.count;d<f;d++)m.setXYZ(d,m.getX(d)+v.getX(d),m.getY(d)+v.getY(d),m.getZ(d)+v.getZ(d))}}return n&&(e.morphAttributes.position=i),a&&(e.morphAttributes.normal=o),e})}(e,t.targets,r):e})}G.prototype.parse=function(e,t){var r=this,n=this.json,a=this.extensions;this.cache.removeAll(),this.markDefs(),Promise.all([this.getDependencies("scene"),this.getDependencies("animation"),this.getDependencies("camera")]).then(function(t){var i={scene:t[0][n.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:n.asset,parser:r,userData:{}};k(a,i,n),N(i,n),e(i)}).catch(t)},G.prototype.markDefs=function(){for(var e=this.json.nodes||[],t=this.json.skins||[],r=this.json.meshes||[],n={},a={},i=0,o=t.length;i<o;i++)for(var s=t[i].joints,l=0,c=s.length;l<c;l++)e[s[l]].isBone=!0;for(var u=0,p=e.length;u<p;u++){var h=e[u];void 0!==h.mesh&&(void 0===n[h.mesh]&&(n[h.mesh]=a[h.mesh]=0),n[h.mesh]++,void 0!==h.skin&&(r[h.mesh].isSkinnedMesh=!0))}this.json.meshReferences=n,this.json.meshUses=a},G.prototype.getDependency=function(e,t){var n=e+":"+t,a=this.cache.get(n);if(!a){switch(e){case"scene":a=this.loadScene(t);break;case"node":a=this.loadNode(t);break;case"mesh":a=this.loadMesh(t);break;case"accessor":a=this.loadAccessor(t);break;case"bufferView":a=this.loadBufferView(t);break;case"buffer":a=this.loadBuffer(t);break;case"material":a=this.loadMaterial(t);break;case"texture":a=this.loadTexture(t);break;case"skin":a=this.loadSkin(t);break;case"animation":a=this.loadAnimation(t);break;case"camera":a=this.loadCamera(t);break;case"light":a=this.extensions[r.KHR_LIGHTS_PUNCTUAL].loadLight(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(n,a)}return a},G.prototype.getDependencies=function(e){var t=this.cache.get(e);if(!t){var r=this,n=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(n.map(function(t,n){return r.getDependency(e,n)})),this.cache.add(e,t)}return t},G.prototype.loadBuffer=function(e){var t=this.json.buffers[e],n=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[r.KHR_BINARY_GLTF].body);var a=this.options;return new Promise(function(e,r){n.load(D(t.uri,a.path),e,void 0,function(){r(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})},G.prototype.loadBufferView=function(e){var t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(e){var r=t.byteLength||0,n=t.byteOffset||0;return e.slice(n,n+r)})},G.prototype.loadAccessor=function(e){var t=this,r=this.json,a=this.json.accessors[e];if(void 0===a.bufferView&&void 0===a.sparse)return Promise.resolve(null);var i=[];return void 0!==a.bufferView?i.push(this.getDependency("bufferView",a.bufferView)):i.push(null),void 0!==a.sparse&&(i.push(this.getDependency("bufferView",a.sparse.indices.bufferView)),i.push(this.getDependency("bufferView",a.sparse.values.bufferView))),Promise.all(i).then(function(e){var i,o,s=e[0],l=A[a.type],c=M[a.componentType],u=c.BYTES_PER_ELEMENT,p=u*l,h=a.byteOffset||0,d=void 0!==a.bufferView?r.bufferViews[a.bufferView].byteStride:void 0,f=!0===a.normalized;if(d&&d!==p){var m="InterleavedBuffer:"+a.bufferView+":"+a.componentType,v=t.cache.get(m);v||(i=new c(s),v=new n.InterleavedBuffer(i,d/u),t.cache.add(m,v)),o=new n.InterleavedBufferAttribute(v,l,h/u,f)}else i=null===s?new c(a.count*l):new c(s,h,a.count*l),o=new n.BufferAttribute(i,l,f);if(void 0!==a.sparse){var g=A.SCALAR,y=M[a.sparse.indices.componentType],b=a.sparse.indices.byteOffset||0,w=a.sparse.values.byteOffset||0,T=new y(e[1],b,a.sparse.count*g),E=new c(e[2],w,a.sparse.count*l);null!==s&&o.setArray(o.array.slice());for(var S=0,x=T.length;S<x;S++){var L=T[S];if(o.setX(L,E[S*l]),l>=2&&o.setY(L,E[S*l+1]),l>=3&&o.setZ(L,E[S*l+2]),l>=4&&o.setW(L,E[S*l+3]),l>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return o})},G.prototype.loadTexture=function(e){var t,a=this,i=this.json,o=this.options,s=this.textureLoader,l=window.URL||window.webkitURL,c=i.textures[e],u=c.extensions||{},p=(t=u[r.MSFT_TEXTURE_DDS]?i.images[u[r.MSFT_TEXTURE_DDS].source]:i.images[c.source]).uri,h=!1;return void 0!==t.bufferView&&(p=a.getDependency("bufferView",t.bufferView).then(function(e){h=!0;var r=new Blob([e],{type:t.mimeType});return p=l.createObjectURL(r)})),Promise.resolve(p).then(function(e){var t=n.Loader.Handlers.get(e);return t||(t=u[r.MSFT_TEXTURE_DDS]?a.extensions[r.MSFT_TEXTURE_DDS].ddsLoader:s),new Promise(function(r,n){t.load(D(e,o.path),r,void 0,n)})}).then(function(e){!0===h&&l.revokeObjectURL(p),e.flipY=!1,void 0!==c.name&&(e.name=c.name),t.mimeType in C&&(e.format=C[t.mimeType]);var r=(i.samplers||{})[c.sampler]||{};return e.magFilter=S[r.magFilter]||n.LinearFilter,e.minFilter=S[r.minFilter]||n.LinearMipMapLinearFilter,e.wrapS=x[r.wrapS]||n.RepeatWrapping,e.wrapT=x[r.wrapT]||n.RepeatWrapping,e})},G.prototype.assignTexture=function(e,t,a){var i=this;return this.getDependency("texture",a.index).then(function(o){if(!o.isCompressedTexture)switch(t){case"aoMap":case"emissiveMap":case"metalnessMap":case"normalMap":case"roughnessMap":o.format=n.RGBFormat}if(i.extensions[r.KHR_TEXTURE_TRANSFORM]){var s=void 0!==a.extensions?a.extensions[r.KHR_TEXTURE_TRANSFORM]:void 0;s&&(o=i.extensions[r.KHR_TEXTURE_TRANSFORM].extendTexture(o,s))}e[t]=o})},G.prototype.assignFinalMaterial=function(e){var t=e.geometry,a=e.material,i=this.extensions,o=void 0!==t.attributes.tangent,s=void 0!==t.attributes.color,l=void 0===t.attributes.normal,c=!0===e.isSkinnedMesh,u=Object.keys(t.morphAttributes).length>0,p=u&&void 0!==t.morphAttributes.normal;if(e.isPoints){var h="PointsMaterial:"+a.uuid,d=this.cache.get(h);d||(d=new n.PointsMaterial,n.Material.prototype.copy.call(d,a),d.color.copy(a.color),d.map=a.map,d.lights=!1,this.cache.add(h,d)),a=d}else if(e.isLine){h="LineBasicMaterial:"+a.uuid;var f=this.cache.get(h);f||(f=new n.LineBasicMaterial,n.Material.prototype.copy.call(f,a),f.color.copy(a.color),f.lights=!1,this.cache.add(h,f)),a=f}if(o||s||l||c||u){h="ClonedMaterial:"+a.uuid+":";a.isGLTFSpecularGlossinessMaterial&&(h+="specular-glossiness:"),c&&(h+="skinning:"),o&&(h+="vertex-tangents:"),s&&(h+="vertex-colors:"),l&&(h+="flat-shading:"),u&&(h+="morph-targets:"),p&&(h+="morph-normals:");var m=this.cache.get(h);m||(m=a.isGLTFSpecularGlossinessMaterial?i[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].cloneMaterial(a):a.clone(),c&&(m.skinning=!0),o&&(m.vertexTangents=!0),s&&(m.vertexColors=n.VertexColors),l&&(m.flatShading=!0),u&&(m.morphTargets=!0),p&&(m.morphNormals=!0),this.cache.add(h,m)),a=m}a.aoMap&&void 0===t.attributes.uv2&&void 0!==t.attributes.uv&&(console.log("THREE.GLTFLoader: Duplicating UVs to support aoMap."),t.addAttribute("uv2",new n.BufferAttribute(t.attributes.uv.array,2))),a.isGLTFSpecularGlossinessMaterial&&(e.onBeforeRender=i[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].refreshUniforms),e.material=a},G.prototype.loadMaterial=function(e){var t,a=this.json,i=this.extensions,o=a.materials[e],s={},l=o.extensions||{},c=[];if(l[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){var u=i[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];t=u.getMaterialType(),c.push(u.extendParams(s,o,this))}else if(l[r.KHR_MATERIALS_UNLIT]){var p=i[r.KHR_MATERIALS_UNLIT];t=p.getMaterialType(),c.push(p.extendParams(s,o,this))}else{t=n.MeshStandardMaterial;var h=o.pbrMetallicRoughness||{};if(s.color=new n.Color(1,1,1),s.opacity=1,Array.isArray(h.baseColorFactor)){var d=h.baseColorFactor;s.color.fromArray(d),s.opacity=d[3]}void 0!==h.baseColorTexture&&c.push(this.assignTexture(s,"map",h.baseColorTexture)),s.metalness=void 0!==h.metallicFactor?h.metallicFactor:1,s.roughness=void 0!==h.roughnessFactor?h.roughnessFactor:1,void 0!==h.metallicRoughnessTexture&&(c.push(this.assignTexture(s,"metalnessMap",h.metallicRoughnessTexture)),c.push(this.assignTexture(s,"roughnessMap",h.metallicRoughnessTexture)))}!0===o.doubleSided&&(s.side=n.DoubleSide);var f=o.alphaMode||_;return f===O?s.transparent=!0:(s.transparent=!1,f===P&&(s.alphaTest=void 0!==o.alphaCutoff?o.alphaCutoff:.5)),void 0!==o.normalTexture&&t!==n.MeshBasicMaterial&&(c.push(this.assignTexture(s,"normalMap",o.normalTexture)),s.normalScale=new n.Vector2(1,1),void 0!==o.normalTexture.scale&&s.normalScale.set(o.normalTexture.scale,o.normalTexture.scale)),void 0!==o.occlusionTexture&&t!==n.MeshBasicMaterial&&(c.push(this.assignTexture(s,"aoMap",o.occlusionTexture)),void 0!==o.occlusionTexture.strength&&(s.aoMapIntensity=o.occlusionTexture.strength)),void 0!==o.emissiveFactor&&t!==n.MeshBasicMaterial&&(s.emissive=(new n.Color).fromArray(o.emissiveFactor)),void 0!==o.emissiveTexture&&t!==n.MeshBasicMaterial&&c.push(this.assignTexture(s,"emissiveMap",o.emissiveTexture)),Promise.all(c).then(function(){var e;return e=t===n.ShaderMaterial?i[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(s):new t(s),void 0!==o.name&&(e.name=o.name),e.map&&(e.map.encoding=n.sRGBEncoding),e.emissiveMap&&(e.emissiveMap.encoding=n.sRGBEncoding),e.specularMap&&(e.specularMap.encoding=n.sRGBEncoding),N(e,o),o.extensions&&k(i,e,o),e})},G.prototype.loadGeometries=function(e){var t=this,a=this.extensions,i=this.primitiveCache;function o(e){return a[r.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then(function(r){return H(r,e,t)})}for(var s=[],l=0,c=e.length;l<c;l++){var u,p=e[l],h=U(p),d=i[h];if(d)s.push(d.promise);else u=p.extensions&&p.extensions[r.KHR_DRACO_MESH_COMPRESSION]?o(p):H(new n.BufferGeometry,p,t),i[h]={primitive:p,promise:u},s.push(u)}return Promise.all(s)},G.prototype.loadMesh=function(e){for(var t=this,r=this.json.meshes[e],a=r.primitives,i=[],o=0,s=a.length;o<s;o++){var l=void 0===a[o].material?m=m||new n.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:n.FrontSide}):this.getDependency("material",a[o].material);i.push(l)}return Promise.all(i).then(function(i){return t.loadGeometries(a).then(function(o){for(var s=[],l=0,c=o.length;l<c;l++){var u,p=o[l],h=a[l],d=i[l];if(h.mode===w||h.mode===T||h.mode===E||void 0===h.mode)!0!==(u=!0===r.isSkinnedMesh?new n.SkinnedMesh(p,d):new n.Mesh(p,d)).isSkinnedMesh||u.geometry.attributes.skinWeight.normalized||u.normalizeSkinWeights(),h.mode===T?u.drawMode=n.TriangleStripDrawMode:h.mode===E&&(u.drawMode=n.TriangleFanDrawMode);else if(h.mode===g)u=new n.LineSegments(p,d);else if(h.mode===b)u=new n.Line(p,d);else if(h.mode===y)u=new n.LineLoop(p,d);else{if(h.mode!==v)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+h.mode);u=new n.Points(p,d)}Object.keys(u.geometry.morphAttributes).length>0&&F(u,r),u.name=r.name||"mesh_"+e,o.length>1&&(u.name+="_"+l),N(u,r),t.assignFinalMaterial(u),s.push(u)}if(1===s.length)return s[0];var f=new n.Group;for(l=0,c=s.length;l<c;l++)f.add(s[l]);return f})})},G.prototype.loadCamera=function(e){var t,r=this.json.cameras[e],a=r[r.type];if(a)return"perspective"===r.type?t=new n.PerspectiveCamera(n.Math.radToDeg(a.yfov),a.aspectRatio||1,a.znear||1,a.zfar||2e6):"orthographic"===r.type&&(t=new n.OrthographicCamera(a.xmag/-2,a.xmag/2,a.ymag/2,a.ymag/-2,a.znear,a.zfar)),void 0!==r.name&&(t.name=r.name),N(t,r),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")},G.prototype.loadSkin=function(e){var t=this.json.skins[e],r={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(r):this.getDependency("accessor",t.inverseBindMatrices).then(function(e){return r.inverseBindMatrices=e,r})},G.prototype.loadAnimation=function(e){for(var t=this.json.animations[e],r=[],a=[],i=[],o=[],s=[],l=0,c=t.channels.length;l<c;l++){var u=t.channels[l],p=t.samplers[u.sampler],h=u.target,d=void 0!==h.node?h.node:h.id,m=void 0!==t.parameters?t.parameters[p.input]:p.input,v=void 0!==t.parameters?t.parameters[p.output]:p.output;r.push(this.getDependency("node",d)),a.push(this.getDependency("accessor",m)),i.push(this.getDependency("accessor",v)),o.push(p),s.push(h)}return Promise.all([Promise.all(r),Promise.all(a),Promise.all(i),Promise.all(o),Promise.all(s)]).then(function(r){for(var a=r[0],i=r[1],o=r[2],s=r[3],l=r[4],c=[],u=0,p=a.length;u<p;u++){var h=a[u],d=i[u],m=o[u],v=s[u],g=l[u];if(void 0!==h){var y;switch(h.updateMatrix(),h.matrixAutoUpdate=!0,R[g.path]){case R.weights:y=n.NumberKeyframeTrack;break;case R.rotation:y=n.QuaternionKeyframeTrack;break;case R.position:case R.scale:default:y=n.VectorKeyframeTrack}var b=h.name?h.name:h.uuid,w=void 0!==v.interpolation?I[v.interpolation]:n.InterpolateLinear,T=[];R[g.path]===R.weights?h.traverse(function(e){!0===e.isMesh&&e.morphTargetInfluences&&T.push(e.name?e.name:e.uuid)}):T.push(b);var E=m.array;if(m.normalized){var M;if(E.constructor===Int8Array)M=1/127;else if(E.constructor===Uint8Array)M=1/255;else if(E.constructor==Int16Array)M=1/32767;else{if(E.constructor!==Uint16Array)throw new Error("THREE.GLTFLoader: Unsupported output accessor component type.");M=1/65535}for(var S=new Float32Array(E.length),x=0,A=E.length;x<A;x++)S[x]=E[x]*M;E=S}for(x=0,A=T.length;x<A;x++){var L=new y(T[x]+"."+R[g.path],d.array,E,w);"CUBICSPLINE"===v.interpolation&&(L.createInterpolant=function(e){return new f(this.times,this.values,this.getValueSize()/3,e)},L.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),c.push(L)}}}var _=void 0!==t.name?t.name:"animation_"+e;return new n.AnimationClip(_,void 0,c)})},G.prototype.loadNode=function(e){var t=this.json,a=this.extensions,i=this,o=t.meshReferences,s=t.meshUses,l=t.nodes[e];return(!0===l.isBone?Promise.resolve(new n.Bone):void 0!==l.mesh?i.getDependency("mesh",l.mesh).then(function(e){var t;if(o[l.mesh]>1){var r=s[l.mesh]++;(t=e.clone()).name+="_instance_"+r,t.onBeforeRender=e.onBeforeRender;for(var n=0,a=t.children.length;n<a;n++)t.children[n].name+="_instance_"+r,t.children[n].onBeforeRender=e.children[n].onBeforeRender}else t=e;return void 0!==l.weights&&t.traverse(function(e){if(e.isMesh)for(var t=0,r=l.weights.length;t<r;t++)e.morphTargetInfluences[t]=l.weights[t]}),t}):void 0!==l.camera?i.getDependency("camera",l.camera):l.extensions&&l.extensions[r.KHR_LIGHTS_PUNCTUAL]&&void 0!==l.extensions[r.KHR_LIGHTS_PUNCTUAL].light?i.getDependency("light",l.extensions[r.KHR_LIGHTS_PUNCTUAL].light):Promise.resolve(new n.Object3D)).then(function(e){if(void 0!==l.name&&(e.userData.name=l.name,e.name=n.PropertyBinding.sanitizeNodeName(l.name)),N(e,l),l.extensions&&k(a,e,l),void 0!==l.matrix){var t=new n.Matrix4;t.fromArray(l.matrix),e.applyMatrix(t)}else void 0!==l.translation&&e.position.fromArray(l.translation),void 0!==l.rotation&&e.quaternion.fromArray(l.rotation),void 0!==l.scale&&e.scale.fromArray(l.scale);return e})},G.prototype.loadScene=function(){function e(t,r,a,i){var o=a.nodes[t];return i.getDependency("node",t).then(function(e){return void 0===o.skin?e:i.getDependency("skin",o.skin).then(function(e){for(var r=[],n=0,a=(t=e).joints.length;n<a;n++)r.push(i.getDependency("node",t.joints[n]));return Promise.all(r)}).then(function(r){for(var a=!0===e.isGroup?e.children:[e],i=0,o=a.length;i<o;i++){for(var s=a[i],l=[],c=[],u=0,p=r.length;u<p;u++){var h=r[u];if(h){l.push(h);var d=new n.Matrix4;void 0!==t.inverseBindMatrices&&d.fromArray(t.inverseBindMatrices.array,16*u),c.push(d)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[u])}s.bind(new n.Skeleton(l,c),s.matrixWorld)}return e});var t}).then(function(t){r.add(t);var n=[];if(o.children)for(var s=o.children,l=0,c=s.length;l<c;l++){var u=s[l];n.push(e(u,t,a,i))}return Promise.all(n)})}return function(t){var r=this.json,a=this.extensions,i=this.json.scenes[t],o=new n.Scene;void 0!==i.name&&(o.name=i.name),N(o,i),i.extensions&&k(a,o,i);for(var s=i.nodes||[],l=[],c=0,u=s.length;c<u;c++)l.push(e(s[c],o,r,this));return Promise.all(l).then(function(){return o})}}()}();class Z extends o{constructor(e,t){super(e),this.sideLength=t,this.lastTime=0,this.init=()=>{(new Y).load("images/planets_tutorial.fbx",e=>{this.mixer=new n.AnimationMixer(e),e.animations.forEach((t,r)=>{this.mixer.clipAction(e.animations[r]).play()}),console.log("Debug 0",e.animations.length),e.traverse(e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)});const t=.002;new n.Vector3(t,t,t);e.scale.set(t,t,t),e.rotateX(Math.PI/2),this._sceneEntityGroup.add(e),this._isSceneEntityReady=!0,this._parentSceneManager.attemptStart()})},this.update=e=>{const t=e-this.lastTime;this.mixer&&this.mixer.update(.1*t),this._sceneEntityGroup.children.forEach(e=>{}),this.lastTime=e}}}class q extends o{constructor(e,t=1){super(e),this._strength=t,this.init=()=>{this._sceneEntityGroup.add(new n.AmbientLight(3355443,this._strength)),this._isSceneEntityReady=!0,this._parentSceneManager.attemptStart()},this.update=e=>{},this.toggleLight=()=>{console.log("",this._strength),this._sceneEntityGroup.traverse(e=>e.visible=!e.visible)}}}class Q extends i{constructor(e){super(e),this.updateCamera=e=>{},this.toggleLight=()=>{this._simpleLight.toggleLight()},e.style.backgroundColor="rgba(0,0,0,1)",this._camera.position.set(6,6,6),this._simpleLight=new q(this,10),this._sceneEntities=[this._simpleLight,new q(this,.3),new Z(this,1)],this._sceneEntities.forEach(e=>e.init()),this._simpleLight.toggleLight(),this._updateCamera=this.updateCamera;this._camera.position.clone()}}r(1);let $;!function(){const e=document.getElementById("canvas-container");if(!e)throw new Error("No container with id canvas-container found!!!");$=new Q(e)}(),document.getElementById("light-toggle").onclick=()=>{$.toggleLight()}}]);